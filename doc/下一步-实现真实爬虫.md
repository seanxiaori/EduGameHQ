# 🚀 下一步：实现真实爬虫逻辑

## 📋 当前状态

✅ **已完成**：
- GitHub Actions工作流 ✅
- 智能爬虫框架 ✅
- 质量评估系统 ✅
- 去重检测工具 ✅
- 配置管理 ✅
- PR自动化 ✅
- 完整文档 ✅

⏳ **待完成**：
- 实现真实的爬虫逻辑
- 测试完整流程
- 首次成功运行

---

## 🎯 需要实现的功能

### 核心任务

在 `scripts/intelligent-game-crawler.mjs` 中，有两个爬虫函数需要实现：

1. **crawlCrazyGames** (优先级高)
2. **crawlCoolMathGames** (可选)

---

## 💻 实现方案

### 方案A：使用Puppeteer（推荐）

**优点**：
- ✅ 可以执行JavaScript
- ✅ 处理动态加载内容
- ✅ 模拟真实浏览器行为
- ✅ 项目已安装

**代码示例**：

```javascript
import puppeteer from 'puppeteer';

async function crawlCrazyGames(categoryConfig) {
  console.log('🕷️ 爬取 CrazyGames...');
  
  const games = [];
  const browser = await puppeteer.launch({
    headless: true,
    args: ['--no-sandbox', '--disable-setuid-sandbox']
  });
  
  try {
    const page = await browser.newPage();
    
    // 设置User-Agent
    await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36');
    
    // 遍历配置的分类
    for (const [category, path] of Object.entries(categoryConfig.categories)) {
      console.log(`   📁 爬取分类: ${category}`);
      
      const url = categoryConfig.baseUrl + path;
      await page.goto(url, { waitUntil: 'networkidle2', timeout: 30000 });
      
      // 提取游戏数据
      const categoryGames = await page.evaluate((cat) => {
        const gameElements = document.querySelectorAll('.game-item'); // 根据实际DOM调整
        const games = [];
        
        gameElements.forEach(el => {
          try {
            const title = el.querySelector('.game-title')?.textContent?.trim();
            const iframeUrl = el.querySelector('a')?.href;
            const thumbnailUrl = el.querySelector('img')?.src;
            const description = el.querySelector('.game-description')?.textContent?.trim();
            
            if (title && iframeUrl) {
              games.push({
                title,
                iframeUrl: iframeUrl.replace('/game/', '/embed/'), // 转换为embed URL
                thumbnailUrl,
                description,
                category: cat,
                categoryName: cat.charAt(0).toUpperCase() + cat.slice(1),
                source: 'CrazyGames',
                sourceUrl: iframeUrl
              });
            }
          } catch (err) {
            console.error('解析游戏失败:', err);
          }
        });
        
        return games;
      }, category);
      
      games.push(...categoryGames);
      console.log(`   ✅ 发现 ${categoryGames.length} 个游戏`);
      
      // 延迟，避免请求过快
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      // 应用限制
      if (games.length >= categoryConfig.limits.gamesPerCategory) {
        break;
      }
    }
    
  } catch (error) {
    console.error('❌ 爬取失败:', error.message);
  } finally {
    await browser.close();
  }
  
  return games;
}
```

### 方案B：使用Cheerio + Axios（轻量级）

**优点**：
- ✅ 更快速
- ✅ 资源消耗少
- ✅ 适合静态页面

**缺点**：
- ❌ 不能执行JavaScript
- ❌ 不适合动态加载的页面

**代码示例**：

```javascript
import axios from 'axios';
import * as cheerio from 'cheerio';

async function crawlCrazyGames(categoryConfig) {
  console.log('🕷️ 爬取 CrazyGames...');
  
  const games = [];
  
  for (const [category, path] of Object.entries(categoryConfig.categories)) {
    try {
      const url = categoryConfig.baseUrl + path;
      const response = await axios.get(url, {
        headers: {
          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        }
      });
      
      const $ = cheerio.load(response.data);
      
      $('.game-item').each((i, el) => {
        const title = $(el).find('.game-title').text().trim();
        const iframeUrl = $(el).find('a').attr('href');
        const thumbnailUrl = $(el).find('img').attr('src');
        
        if (title && iframeUrl) {
          games.push({
            title,
            iframeUrl: categoryConfig.baseUrl + iframeUrl.replace('/game/', '/embed/'),
            thumbnailUrl,
            category,
            categoryName: category.charAt(0).toUpperCase() + category.slice(1)
          });
        }
      });
      
      await new Promise(resolve => setTimeout(resolve, 2000));
      
    } catch (error) {
      console.error(`爬取${category}失败:`, error.message);
    }
  }
  
  return games;
}
```

---

## 📝 实施步骤

### 第1步：安装依赖（如果需要）

```bash
# Cheerio方案需要额外安装
npm install cheerio axios
```

### 第2步：研究目标网站

1. 打开 https://www.crazygames.com/c/math
2. 使用浏览器开发者工具（F12）
3. 查看游戏列表的DOM结构
4. 找到游戏卡片的CSS选择器
5. 确定如何提取：
   - 游戏标题
   - 游戏链接
   - 缩略图
   - 评分
   - 播放次数

### 第3步：修改爬虫代码

在 `scripts/intelligent-game-crawler.mjs` 中找到：

```javascript
async function crawlCrazyGames(categoryConfig) {
  console.log('🕷️ 爬取 CrazyGames...');
  
  const mockGames = []; // <-- 删除这行
  
  console.log('   ℹ️ 注意：当前为演示模式，需要实现真实爬虫逻辑'); // <-- 删除这行
  
  return mockGames; // <-- 删除这行
}
```

替换为上面的真实实现。

### 第4步：本地测试

```bash
# 运行爬虫
node scripts/intelligent-game-crawler.mjs

# 检查结果
# 如果成功，会生成：
# - scripts/temp/new-games.json
# - scripts/temp/pr-body.md
```

### 第5步：调试和优化

常见问题和解决方案：

**问题1：找不到游戏元素**
```javascript
// 调试代码
const html = await page.content();
console.log(html); // 查看完整HTML
```

**问题2：超时**
```javascript
await page.goto(url, { 
  waitUntil: 'domcontentloaded', // 改为更快的等待策略
  timeout: 60000 
});
```

**问题3：反爬虫**
```javascript
// 设置更真实的浏览器环境
await page.setExtraHTTPHeaders({
  'Accept-Language': 'en-US,en;q=0.9'
});
```

### 第6步：GitHub Actions测试

1. 提交代码到GitHub
2. 手动触发Actions
3. 查看运行日志
4. 检查是否创建PR

---

## 🛠️ 调试技巧

### 截图调试

```javascript
// 在爬虫中添加截图
await page.screenshot({ path: 'debug-screenshot.png' });
```

### 控制台日志

```javascript
page.on('console', msg => console.log('浏览器日志:', msg.text()));
```

### 详细错误

```javascript
try {
  // 爬虫代码
} catch (error) {
  console.error('详细错误:', error);
  console.error('堆栈:', error.stack);
}
```

---

## 📚 参考资源

### CrazyGames API

查看是否有官方API：
- https://www.crazygames.com/developers
- 如果有API，优先使用API而不是爬虫

### DOM选择器

常用工具：
- Chrome DevTools → Elements → Copy selector
- SelectorGadget浏览器插件

### Puppeteer文档

- 官方文档: https://pptr.dev/
- 示例: https://github.com/puppeteer/puppeteer/tree/main/examples

---

## ⚠️ 注意事项

### 1. 遵守网站规则

- 查看并遵守 robots.txt
- 不要请求过于频繁
- 尊重网站的服务条款

### 2. 错误处理

```javascript
// 每个网站都要try-catch
try {
  const games = await crawlWebsite();
} catch (error) {
  console.error('爬取失败，继续其他源:', error);
  return []; // 返回空数组，不中断流程
}
```

### 3. 延迟控制

```javascript
// 每次请求间隔2-5秒
await delay(2000 + Math.random() * 3000);
```

### 4. 数据验证

```javascript
// 确保必需字段存在
if (!game.title || !game.iframeUrl) {
  console.warn('游戏数据不完整，跳过');
  continue;
}
```

---

## 🎯 成功标准

完成后应该能够：

✅ 本地运行 `node scripts/intelligent-game-crawler.mjs`
✅ 成功爬取至少5个游戏
✅ 生成 `scripts/temp/new-games.json`
✅ 游戏数据包含所有必需字段
✅ GitHub Actions能成功运行
✅ 自动创建PR

---

## 💡 快速开始建议

### 最小可行实现

先实现一个最简单的版本：

```javascript
async function crawlCrazyGames(categoryConfig) {
  // 硬编码几个游戏用于测试
  return [
    {
      title: 'Test Math Game',
      iframeUrl: 'https://www.crazygames.com/embed/2048',
      thumbnailUrl: 'https://example.com/thumb.jpg',
      description: 'A test game',
      category: 'math',
      categoryName: 'Math',
      rating: 4.5,
      playCount: 100000,
      technology: 'HTML5',
      mobileSupport: true,
      responsive: true
    }
  ];
}
```

测试整个流程能否跑通，然后再实现真实爬虫。

---

## 📞 需要帮助？

如果遇到困难：

1. 查看Puppeteer示例代码
2. 检查目标网站的DOM结构
3. 使用浏览器开发者工具调试
4. 创建GitHub Issue描述问题

---

**祝实现顺利！** 🚀

完成后，整个自动游戏发现系统就可以投入使用了！

