---
// 启用服务器端渲染以支持搜索参数
export const prerender = false;

import BaseLayout from '../layouts/BaseLayout.astro';
import GameCard from '../components/GameCard.astro';
import type { Game } from '../types/game';
import fs from 'fs';
import path from 'path';

// 搜索相关的SEO数据
let seoData = {
  title: "Search Educational Games | EduGameHQ",
  description: "Search through our collection of educational games for kids aged 6-18. Find math, science, coding, language, and puzzle games.",
  keywords: ["search games", "educational games", "learning games", "kids games", "school games"]
};

// 从JSON文件读取游戏数据
const gamesDataPath = path.join(process.cwd(), 'src/data/games.json');
let allGames: Game[] = [];

try {
  const fileContent = fs.readFileSync(gamesDataPath, 'utf-8');
  allGames = JSON.parse(fileContent) as Game[];
} catch (error) {
  console.warn('无法读取游戏数据文件:', error);
}

// 获取搜索查询参数
const url = new URL(Astro.request.url);
const searchQuery = url.searchParams.get('q')?.trim() || '';

// 执行搜索逻辑
let searchResults: Game[] = [];
let hasSearched = false;

if (searchQuery) {
  hasSearched = true;
  const searchTerm = searchQuery.toLowerCase();
  
  // 简单但有效的搜索逻辑
  searchResults = allGames.filter(game => {
    return (
      // 按游戏标题搜索
      game.title.toLowerCase().includes(searchTerm) ||
      // 按游戏描述搜索
      game.description.toLowerCase().includes(searchTerm) ||
      // 按游戏分类搜索
      game.category.toLowerCase().includes(searchTerm) ||
      // 按游戏标签搜索（如果有）
      (game.tags && game.tags.some(tag => tag.toLowerCase().includes(searchTerm))) ||
      // 按开发者搜索（如果有）
      (game.developer && game.developer.toLowerCase().includes(searchTerm))
    );
  });
  
  // 更新SEO数据
  if (searchResults.length > 0) {
    seoData.title = `${searchQuery} Games - Found ${searchResults.length} Results | EduGameHQ`;
    seoData.description = `Discover ${searchResults.length} educational ${searchQuery} games for kids. Play fun and engaging learning games online.`;
  } else {
    seoData.title = `No Results for "${searchQuery}" | EduGameHQ`;
    seoData.description = `No games found for "${searchQuery}". Try different keywords or explore our popular educational games.`;
  }
}

// 获取推荐的热门游戏（用于无搜索结果时显示）
const popularGames = allGames
  .filter(game => game.featured || game.popularity > 800)
  .slice(0, 12);

// 热门搜索关键词
const popularSearchTerms = [
  { term: 'math', icon: 'fa-calculator', color: 'blue' },
  { term: 'science', icon: 'fa-flask', color: 'green' },
  { term: 'coding', icon: 'fa-code', color: 'purple' },
  { term: 'puzzle', icon: 'fa-puzzle-piece', color: 'orange' },
  { term: 'language', icon: 'fa-language', color: 'red' },
  { term: 'geography', icon: 'fa-globe', color: 'teal' }
];
---

<BaseLayout title={seoData.title} description={seoData.description}>
  <!-- 引入统一游戏卡片样式 -->
  <link rel="stylesheet" href="/src/styles/game-card.css">
  
  <main class="main-content">
    <div class="content-wrapper">
      
      <!-- 搜索头部 -->
      <section class="search-header">
        <div class="header-content">
          <div class="header-icon">
            <div class="section-icon search">
              <i class="fas fa-search"></i>
            </div>
          </div>
          <div class="header-text">
            {hasSearched ? (
              <div>
                <h1 class="page-title">
                  {searchResults.length > 0 
                    ? `Found ${searchResults.length} Results` 
                    : 'No Results Found'
                  }
                </h1>
                <p class="page-description">
                  Search results for: <strong>"{searchQuery}"</strong>
                </p>
              </div>
            ) : (
              <div>
                <h1 class="page-title">Search Educational Games</h1>
                <p class="page-description">
                  Find the perfect educational game for your learning journey
                </p>
              </div>
            )}
          </div>
        </div>
      </section>

      {/* 如果没有搜索查询，显示搜索提示 */}
      {!hasSearched && (
        <section class="search-prompt">
          <div class="module-header">
            <div class="module-icon prompt-icon">
              <i class="fas fa-lightbulb"></i>
            </div>
            <div class="module-title-group">
              <h2 class="module-title">Start Your Learning Adventure</h2>
              <p class="module-subtitle">Use the search bar above to find educational games by subject, difficulty, or keywords</p>
            </div>
          </div>
          
          <div class="popular-searches">
            <h3 class="section-title">Popular Searches</h3>
            <div class="search-tags">
              {popularSearchTerms.map(item => (
                <a href={`/search?q=${item.term}`} class={`search-tag ${item.color}`}>
                  <i class={`fas ${item.icon}`}></i>
                  <span>{item.term.charAt(0).toUpperCase() + item.term.slice(1)}</span>
                </a>
              ))}
            </div>
          </div>
        </section>
      )}

      {/* 如果有搜索查询但没有结果 */}
      {hasSearched && searchResults.length === 0 && (
        <section class="no-results">
          <div class="module-header">
            <div class="module-icon no-results-icon">
              <i class="fas fa-search"></i>
            </div>
            <div class="module-title-group">
              <h2 class="module-title">No Games Found</h2>
              <p class="module-subtitle">Sorry, we couldn't find any games matching "{searchQuery}"</p>
            </div>
          </div>
          
          <div class="search-suggestions">
            <h3 class="section-title">Try searching for:</h3>
            <div class="search-tags">
              {popularSearchTerms.map(item => (
                <a href={`/search?q=${item.term}`} class={`search-tag ${item.color}`}>
                  <i class={`fas ${item.icon}`}></i>
                  <span>{item.term.charAt(0).toUpperCase() + item.term.slice(1)} Games</span>
                </a>
              ))}
            </div>
          </div>
        </section>
      )}

      {/* 搜索结果 */}
      {hasSearched && searchResults.length > 0 && (
        <section class="search-results">
          <div class="module-header">
            <div class="module-icon results-icon">
              <i class="fas fa-gamepad"></i>
            </div>
            <div class="module-title-group">
              <h2 class="module-title">Search Results</h2>
              <p class="module-subtitle">Found {searchResults.length} games matching "{searchQuery}"</p>
            </div>
          </div>
          
          <div class="games-grid">
            {searchResults.map((game) => (
              <GameCard 
                game={game} 
                showPopularity={true} 
                showFavorite={true} 
                showDeveloper={false}
              />
            ))}
          </div>
        </section>
      )}

      {/* 推荐游戏（当没有搜索或没有结果时显示） */}
      {(!hasSearched || searchResults.length === 0) && (
        <section class="recommendations">
          <div class="module-header">
            <div class="module-icon recommendations-icon">
              <i class="fas fa-star"></i>
            </div>
            <div class="module-title-group">
              <h2 class="module-title">{hasSearched ? 'You Might Like These Games' : 'Popular Educational Games'}</h2>
              <p class="module-subtitle">{hasSearched ? 'Try these popular games instead' : 'Start with our most loved educational games'}</p>
            </div>
          </div>
          
          <div class="games-grid">
            {popularGames.map((game) => (
              <GameCard 
                game={game} 
                showPopularity={true} 
                showFavorite={true} 
                showDeveloper={false}
              />
            ))}
          </div>
        </section>
      )}

    </div>
  </main>
</BaseLayout>

<style>
  /* 主要内容区域 */
  .main-content {
    width: 100%;
    background: linear-gradient(135deg, #FEFCFB 0%, #FEF3E2 50%, rgba(245, 158, 11, 0.05) 100%);
    min-height: 100vh;
  }

  .content-wrapper {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
  }

  /* 搜索头部 - 橙色主题 */
  .search-header {
    background: linear-gradient(135deg, #FEF3E2 0%, #FED7AA 50%, #F59E0B 100%);
    border-radius: 20px;
    padding: 3rem;
    margin-bottom: 3rem;
    box-shadow: 0 4px 14px 0 rgba(245, 158, 11, 0.2);
    position: relative;
    overflow: hidden;
  }

  .search-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.2), transparent 50%);
  }

  .header-content {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    position: relative;
    z-index: 1;
  }

  .header-icon {
    flex-shrink: 0;
  }

  .section-icon {
    width: 64px;
    height: 64px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  .section-icon.search {
    background: linear-gradient(135deg, #F59E0B, #D97706);
  }

  .header-text {
    flex: 1;
  }

  .page-title {
    font-family: 'Space Grotesk', sans-serif;
    font-size: 2.5rem;
    font-weight: 800;
    margin: 0 0 0.5rem 0;
    color: #92400E;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    line-height: 1.2;
  }

  .page-description {
    font-size: 1.125rem;
    color: #78350F;
    margin: 0;
    font-weight: 500;
    line-height: 1.6;
  }

  .page-description strong {
    color: #92400E;
    font-weight: 700;
  }

  /* 通用模块样式 */
  .search-prompt,
  .search-results,
  .no-results,
  .recommendations {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    margin-bottom: 3rem;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    border: 1px solid #E5E7EB;
  }

  .module-header {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 2px solid #F3F4F6;
  }

  .module-icon {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.25rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    flex-shrink: 0;
  }

  .prompt-icon {
    background: linear-gradient(135deg, #F59E0B, #D97706);
  }

  .results-icon {
    background: linear-gradient(135deg, #059669, #047857);
  }

  .no-results-icon {
    background: linear-gradient(135deg, #6B7280, #4B5563);
  }

  .recommendations-icon {
    background: linear-gradient(135deg, #DC2626, #B91C1C);
  }

  .module-title-group {
    flex: 1;
  }

  .module-title {
    font-size: 1.75rem;
    font-weight: 700;
    color: #1F2937;
    margin: 0 0 0.25rem 0;
    font-family: 'Space Grotesk', sans-serif;
  }

  .module-subtitle {
    font-size: 1rem;
    color: #6B7280;
    margin: 0;
    font-weight: 500;
  }

  /* 搜索标签 */
  .section-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #1F2937;
    margin: 0 0 1.5rem 0;
    text-align: center;
    font-family: 'Space Grotesk', sans-serif;
  }

  .search-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    justify-content: center;
  }

  .search-tag {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    border-radius: 12px;
    text-decoration: none;
    font-weight: 600;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    border: 2px solid transparent;
  }

  /* 搜索标签颜色变体 */
  .search-tag.blue {
    background: linear-gradient(135deg, #DBEAFE, #BFDBFE);
    color: #1D4ED8;
  }

  .search-tag.blue:hover {
    background: linear-gradient(135deg, #3B82F6, #2563EB);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  }

  .search-tag.green {
    background: linear-gradient(135deg, #D1FAE5, #A7F3D0);
    color: #059669;
  }

  .search-tag.green:hover {
    background: linear-gradient(135deg, #10B981, #059669);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
  }

  .search-tag.purple {
    background: linear-gradient(135deg, #EDE9FE, #DDD6FE);
    color: #7C3AED;
  }

  .search-tag.purple:hover {
    background: linear-gradient(135deg, #8B5CF6, #7C3AED);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
  }

  .search-tag.orange {
    background: linear-gradient(135deg, #FED7AA, #FDBA74);
    color: #D97706;
  }

  .search-tag.orange:hover {
    background: linear-gradient(135deg, #F59E0B, #D97706);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
  }

  .search-tag.red {
    background: linear-gradient(135deg, #FEE2E2, #FECACA);
    color: #DC2626;
  }

  .search-tag.red:hover {
    background: linear-gradient(135deg, #EF4444, #DC2626);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
  }

  .search-tag.teal {
    background: linear-gradient(135deg, #CCFBF1, #99F6E4);
    color: #0F766E;
  }

  .search-tag.teal:hover {
    background: linear-gradient(135deg, #14B8A6, #0F766E);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(20, 184, 166, 0.3);
  }

  /* 游戏网格 */
  .games-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1.5rem;
  }

  /* 搜索建议和热门搜索 */
  .popular-searches,
  .search-suggestions {
    padding: 1.5rem 0;
  }

  /* 响应式设计 */
  @media (max-width: 1024px) {
    .content-wrapper {
      padding: 1.5rem;
    }
    
    .search-header {
      padding: 2rem;
    }
    
    .header-content {
      flex-direction: column;
      gap: 1rem;
      text-align: center;
    }
  }

  @media (max-width: 768px) {
    .content-wrapper {
      padding: 1rem;
    }
    
    .search-header {
      padding: 1.5rem;
    }
    
    .page-title {
      font-size: 2rem;
    }
    
    .games-grid {
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 1rem;
    }
    
    .search-prompt,
    .search-results,
    .no-results,
    .recommendations {
      padding: 1.5rem;
    }
    
    .search-tags {
      gap: 0.75rem;
    }
    
    .search-tag {
      padding: 0.625rem 1rem;
      font-size: 0.9rem;
    }
  }

  @media (max-width: 480px) {
    .games-grid {
      grid-template-columns: 1fr;
    }
    
    .search-tags {
      flex-direction: column;
      align-items: center;
    }
    
    .search-tag {
      width: 100%;
      max-width: 240px;
      justify-content: center;
    }
  }
</style> 


