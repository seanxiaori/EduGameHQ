---
import BaseLayout from '../layouts/BaseLayout.astro';
import type { Game } from '../types/game';
import gamesData from '../data/games/games.json';

// 获取搜索查询参数
const url = new URL(Astro.request.url);
const query = url.searchParams.get('q') || '';
const searchQuery = query.toLowerCase().trim();

// 调试信息
console.log('=== SEARCH PAGE DEBUG ===');
console.log('Full URL:', url.toString());
console.log('Search params:', Object.fromEntries(url.searchParams.entries()));
console.log('Query param "q":', url.searchParams.get('q'));
console.log('Processed query:', query);
console.log('Search query (lowercase):', searchQuery);
console.log('Query length:', query.length);

// 将游戏对象转换为数组，并添加slug属性
const games: Game[] = Object.entries(gamesData).map(([slug, game]) => ({
  ...game,
  slug
})) as Game[];

console.log('Total games loaded:', games.length);
console.log('Sample game:', games[0]);

// 改进的搜索逻辑
let searchResults: Game[] = [];
let hasResults = false;

if (searchQuery) {
  console.log('Performing search for:', searchQuery);
  
  searchResults = games.filter(game => {
    // 更宽松的搜索条件
    const titleMatch = game.title.toLowerCase().includes(searchQuery);
    const descriptionMatch = game.description?.toLowerCase().includes(searchQuery) || false;
    const categoryMatch = game.category?.toLowerCase().includes(searchQuery) || false;
    const categoryNameMatch = game.categoryName?.toLowerCase().includes(searchQuery) || false;
    const tagsMatch = game.tags?.some(tag => tag.toLowerCase().includes(searchQuery)) || false;
    const ageRangeMatch = game.ageRange?.toLowerCase().includes(searchQuery) || false;
    const difficultyMatch = game.difficulty?.toLowerCase().includes(searchQuery) || false;
    
    // 特殊关键词匹配
    let specialMatch = false;
    if (searchQuery === 'math' || searchQuery === 'mathematics') {
      specialMatch = game.category === 'math' || game.categoryName?.toLowerCase().includes('math');
    } else if (searchQuery === 'science') {
      specialMatch = game.category === 'science' || game.categoryName?.toLowerCase().includes('science');
    } else if (searchQuery === 'coding' || searchQuery === 'programming') {
      specialMatch = game.category === 'coding' || game.categoryName?.toLowerCase().includes('programming');
    } else if (searchQuery === 'language' || searchQuery === 'english') {
      specialMatch = game.category === 'language' || game.categoryName?.toLowerCase().includes('language');
    } else if (searchQuery === 'puzzle') {
      specialMatch = game.category === 'puzzle' || game.categoryName?.toLowerCase().includes('puzzle');
    } else if (searchQuery === 'sports') {
      specialMatch = game.category === 'sports' || game.categoryName?.toLowerCase().includes('sports');
    } else if (searchQuery === 'art' || searchQuery === 'creativity') {
      specialMatch = game.category === 'art' || game.categoryName?.toLowerCase().includes('art');
    } else if (searchQuery === 'geography' || searchQuery === 'history') {
      specialMatch = game.category === 'geography' || game.categoryName?.toLowerCase().includes('geography');
    }
    
    const isMatch = titleMatch || descriptionMatch || categoryMatch || categoryNameMatch || tagsMatch || ageRangeMatch || difficultyMatch || specialMatch;
    
    if (isMatch) {
      console.log('Match found:', {
        title: game.title,
        category: game.category,
        categoryName: game.categoryName,
        titleMatch,
        categoryMatch,
        categoryNameMatch,
        specialMatch
      });
    }
    
    return isMatch;
  });
  
  hasResults = searchResults.length > 0;
  console.log('Search results count:', searchResults.length);
  console.log('Has results:', hasResults);
  
  if (searchResults.length > 0) {
    console.log('First few results:', searchResults.slice(0, 3).map(g => ({ title: g.title, category: g.category })));
  }
}

// 页面标题和描述
const pageTitle = searchQuery 
  ? `Search Results for "${query}" | EduGameHQ`
  : 'Search Educational Games | EduGameHQ';

const pageDescription = searchQuery
  ? `Found ${searchResults.length} educational games matching "${query}". Play free learning games for kids aged 6-18.`
  : 'Search through our collection of 240+ free educational games. Find math, science, coding, language, sports, art and geography games.';
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <div class="search-page">
    <div class="container mx-auto px-4 py-8">
      
      {searchQuery ? (
        hasResults ? (
          <!-- 搜索结果 -->
          <div class="search-results">
            <div class="search-header mb-8">
              <h1 class="text-3xl font-bold text-gray-900 mb-2">
                Search Results for "{query}"
              </h1>
              <p class="text-gray-600">
                Found {searchResults.length} games matching your search
              </p>
            </div>
            
            <!-- 游戏网格 -->
            <div class="games-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
              {searchResults.map((game) => (
                <div class="game-card bg-white rounded-xl shadow-md hover:shadow-lg transition-all duration-300 overflow-hidden group">
                  <div class="game-image-container relative">
                    <img 
                      src={game.images?.[0] ? `/images/games/intro/${game.images[0]}` : '/images/game-placeholder.jpg'} 
                      alt={game.title}
                      class="w-full h-48 object-cover group-hover:scale-105 transition-transform duration-300"
                      loading="lazy"
                    />
                    <div class="play-overlay absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                      <a 
                        href={`/games/${game.slug}`}
                        class="play-btn bg-white text-gray-900 px-6 py-3 rounded-full font-semibold hover:bg-gray-100 transition-colors duration-200 flex items-center gap-2"
                      >
                        <i class="fas fa-play"></i>
                        Play Now
                      </a>
                    </div>
                  </div>
                  
                  <div class="game-info p-4">
                    <h3 class="game-title text-lg font-semibold text-gray-900 mb-2 line-clamp-1">
                      {game.title}
                    </h3>
                    <p class="game-description text-gray-600 text-sm mb-3 line-clamp-2">
                      {game.description && game.description.length > 100 ? game.description.substring(0, 100) + '...' : game.description}
                    </p>
                    <div class="game-meta flex items-center justify-between">
                      <span class={`category-badge px-3 py-1 rounded-full text-xs font-medium ${
                        game.category === 'math' ? 'bg-orange-100 text-orange-800' :
                        game.category === 'science' ? 'bg-green-100 text-green-800' :
                        game.category === 'coding' ? 'bg-blue-100 text-blue-800' :
                        game.category === 'language' ? 'bg-purple-100 text-purple-800' :
                        game.category === 'puzzle' ? 'bg-indigo-100 text-indigo-800' :
                        game.category === 'sports' ? 'bg-red-100 text-red-800' :
                        game.category === 'art' ? 'bg-pink-100 text-pink-800' :
                        game.category === 'geography' ? 'bg-teal-100 text-teal-800' :
                        'bg-gray-100 text-gray-800'
                      }`}>
                        {game.categoryName || game.category}
                      </span>
                      <div class="game-stats text-xs text-gray-500">
                        <i class="fas fa-users mr-1"></i>
                        {game.playCount || Math.floor(Math.random() * 1000) + 100}
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
            
            <!-- 搜索建议 -->
            <div class="search-suggestions-section mt-12">
              <h2 class="text-xl font-semibold text-gray-900 mb-6">Try searching for:</h2>
              <div class="search-tags flex flex-wrap gap-2">
                <a href="/search?q=math" class="search-tag bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-sm hover:bg-orange-200 transition-colors">Math Games</a>
                <a href="/search?q=science" class="search-tag bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm hover:bg-green-200 transition-colors">Science Games</a>
                <a href="/search?q=coding" class="search-tag bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm hover:bg-blue-200 transition-colors">Coding Games</a>
                <a href="/search?q=language" class="search-tag bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm hover:bg-purple-200 transition-colors">Language Games</a>
                <a href="/search?q=puzzle" class="search-tag bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm hover:bg-indigo-200 transition-colors">Puzzle Games</a>
                <a href="/search?q=sports" class="search-tag bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm hover:bg-red-200 transition-colors">Sports Games</a>
                <a href="/search?q=2048" class="search-tag bg-gray-100 text-gray-800 px-3 py-1 rounded-full text-sm hover:bg-gray-200 transition-colors">2048</a>
                <a href="/search?q=duck" class="search-tag bg-gray-100 text-gray-800 px-3 py-1 rounded-full text-sm hover:bg-gray-200 transition-colors">Math Duck</a>
              </div>
            </div>
          </div>
        ) : (
          <!-- 无搜索结果 -->
          <div class="no-results text-center py-12">
            <div class="no-results-icon mb-6">
              <i class="fas fa-search text-6xl text-gray-300"></i>
            </div>
            <h1 class="text-3xl font-bold text-gray-900 mb-4">
              No games found for "{query}"
            </h1>
            <p class="text-gray-600 mb-8 max-w-md mx-auto">
              We couldn't find any games matching your search. Try different keywords or browse our categories below.
            </p>
            
            <!-- 搜索建议 -->
            <div class="search-suggestions-section mb-8">
              <h2 class="text-xl font-semibold text-gray-900 mb-4">Popular searches:</h2>
              <div class="search-tags flex flex-wrap justify-center gap-2 mb-8">
                <a href="/search?q=math" class="search-tag bg-orange-100 text-orange-800 px-4 py-2 rounded-full hover:bg-orange-200 transition-colors">Math Games</a>
                <a href="/search?q=science" class="search-tag bg-green-100 text-green-800 px-4 py-2 rounded-full hover:bg-green-200 transition-colors">Science Games</a>
                <a href="/search?q=coding" class="search-tag bg-blue-100 text-blue-800 px-4 py-2 rounded-full hover:bg-blue-200 transition-colors">Coding Games</a>
                <a href="/search?q=2048" class="search-tag bg-gray-100 text-gray-800 px-4 py-2 rounded-full hover:bg-gray-200 transition-colors">2048</a>
                <a href="/search?q=duck" class="search-tag bg-gray-100 text-gray-800 px-4 py-2 rounded-full hover:bg-gray-200 transition-colors">Math Duck</a>
              </div>
            </div>
            
            <!-- 推荐分类 -->
            <div class="recommended-categories">
              <h2 class="text-xl font-semibold text-gray-900 mb-6">Browse by Category</h2>
              <div class="categories-grid grid grid-cols-2 md:grid-cols-4 gap-4 max-w-4xl mx-auto">
                <a href="/math-games" class="category-card bg-orange-50 hover:bg-orange-100 p-4 rounded-lg transition-colors duration-200">
                  <i class="fas fa-calculator text-2xl text-orange-600 mb-2"></i>
                  <h3 class="font-semibold text-gray-900">Math Games</h3>
                </a>
                <a href="/science-games" class="category-card bg-green-50 hover:bg-green-100 p-4 rounded-lg transition-colors duration-200">
                  <i class="fas fa-flask text-2xl text-green-600 mb-2"></i>
                  <h3 class="font-semibold text-gray-900">Science Games</h3>
                </a>
                <a href="/coding-games" class="category-card bg-blue-50 hover:bg-blue-100 p-4 rounded-lg transition-colors duration-200">
                  <i class="fas fa-code text-2xl text-blue-600 mb-2"></i>
                  <h3 class="font-semibold text-gray-900">Coding Games</h3>
                </a>
                <a href="/language-games" class="category-card bg-purple-50 hover:bg-purple-100 p-4 rounded-lg transition-colors duration-200">
                  <i class="fas fa-book-open text-2xl text-purple-600 mb-2"></i>
                  <h3 class="font-semibold text-gray-900">Language Games</h3>
                </a>
              </div>
            </div>
          </div>
        )
      ) : (
        <!-- 空搜索状态 -->
        <div class="empty-search text-center py-12">
          <div class="search-icon mb-6">
            <i class="fas fa-search text-6xl text-gray-300"></i>
          </div>
          <h1 class="text-3xl font-bold text-gray-900 mb-4">
            Search Educational Games
          </h1>
          <p class="text-gray-600 mb-8 max-w-md mx-auto">
            Enter keywords to search through our collection of 240+ educational games for kids aged 6-18.
          </p>
          
          <!-- 热门搜索 -->
          <div class="popular-searches mb-8">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Popular searches:</h2>
            <div class="search-tags flex flex-wrap justify-center gap-2 mb-8">
              <a href="/search?q=math" class="search-tag bg-orange-100 text-orange-800 px-4 py-2 rounded-full hover:bg-orange-200 transition-colors">Math Games</a>
              <a href="/search?q=science" class="search-tag bg-green-100 text-green-800 px-4 py-2 rounded-full hover:bg-green-200 transition-colors">Science Games</a>
              <a href="/search?q=coding" class="search-tag bg-blue-100 text-blue-800 px-4 py-2 rounded-full hover:bg-blue-200 transition-colors">Coding Games</a>
              <a href="/search?q=language" class="search-tag bg-purple-100 text-purple-800 px-4 py-2 rounded-full hover:bg-purple-200 transition-colors">Language Games</a>
              <a href="/search?q=2048" class="search-tag bg-gray-100 text-gray-800 px-4 py-2 rounded-full hover:bg-gray-200 transition-colors">2048</a>
              <a href="/search?q=duck" class="search-tag bg-gray-100 text-gray-800 px-4 py-2 rounded-full hover:bg-gray-200 transition-colors">Math Duck</a>
            </div>
          </div>
          
          <!-- 分类链接 -->
          <div class="categories-showcase">
            <h2 class="text-xl font-semibold text-gray-900 mb-6">Browse by Category</h2>
            <div class="categories-grid grid grid-cols-2 md:grid-cols-4 gap-4 max-w-4xl mx-auto">
              <a href="/math-games" class="category-card bg-orange-50 hover:bg-orange-100 p-6 rounded-lg transition-colors duration-200">
                <i class="fas fa-calculator text-3xl text-orange-600 mb-3"></i>
                <h3 class="font-semibold text-gray-900 mb-1">Math Games</h3>
                <p class="text-sm text-gray-600">30+ games</p>
              </a>
              <a href="/science-games" class="category-card bg-green-50 hover:bg-green-100 p-6 rounded-lg transition-colors duration-200">
                <i class="fas fa-flask text-3xl text-green-600 mb-3"></i>
                <h3 class="font-semibold text-gray-900 mb-1">Science Games</h3>
                <p class="text-sm text-gray-600">30+ games</p>
              </a>
              <a href="/coding-games" class="category-card bg-blue-50 hover:bg-blue-100 p-6 rounded-lg transition-colors duration-200">
                <i class="fas fa-code text-3xl text-blue-600 mb-3"></i>
                <h3 class="font-semibold text-gray-900 mb-1">Coding Games</h3>
                <p class="text-sm text-gray-600">30+ games</p>
              </a>
              <a href="/language-games" class="category-card bg-purple-50 hover:bg-purple-100 p-6 rounded-lg transition-colors duration-200">
                <i class="fas fa-book-open text-3xl text-purple-600 mb-3"></i>
                <h3 class="font-semibold text-gray-900 mb-1">Language Games</h3>
                <p class="text-sm text-gray-600">30+ games</p>
              </a>
              <a href="/sports-games" class="category-card bg-red-50 hover:bg-red-100 p-6 rounded-lg transition-colors duration-200">
                <i class="fas fa-running text-3xl text-red-600 mb-3"></i>
                <h3 class="font-semibold text-gray-900 mb-1">Sports Games</h3>
                <p class="text-sm text-gray-600">30+ games</p>
              </a>
              <a href="/art-games" class="category-card bg-pink-50 hover:bg-pink-100 p-6 rounded-lg transition-colors duration-200">
                <i class="fas fa-palette text-3xl text-pink-600 mb-3"></i>
                <h3 class="font-semibold text-gray-900 mb-1">Art & Creativity</h3>
                <p class="text-sm text-gray-600">30+ games</p>
              </a>
              <a href="/geography-games" class="category-card bg-teal-50 hover:bg-teal-100 p-6 rounded-lg transition-colors duration-200">
                <i class="fas fa-globe text-3xl text-teal-600 mb-3"></i>
                <h3 class="font-semibold text-gray-900 mb-1">Geography</h3>
                <p class="text-sm text-gray-600">30+ games</p>
              </a>
              <a href="/puzzle-games" class="category-card bg-indigo-50 hover:bg-indigo-100 p-6 rounded-lg transition-colors duration-200">
                <i class="fas fa-puzzle-piece text-3xl text-indigo-600 mb-3"></i>
                <h3 class="font-semibold text-gray-900 mb-1">Puzzle Games</h3>
                <p class="text-sm text-gray-600">30+ games</p>
              </a>
            </div>
          </div>
        </div>
      )}
    </div>
  </div>
</BaseLayout>

<style>
  .search-page {
    min-height: calc(100vh - 140px);
    background: linear-gradient(135deg, #FEFCFB 0%, #F8F6F3 50%, #FFF7ED 100%);
  }

  .game-card {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .game-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
  }

  .line-clamp-1 {
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .search-tag {
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .search-tag:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .category-card {
    text-align: center;
    transition: all 0.3s ease;
  }

  .category-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  @media (max-width: 768px) {
    .games-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }
    
    .categories-grid {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .search-tags {
      justify-content: center;
    }
  }

  @media (max-width: 640px) {
    .games-grid {
      grid-template-columns: 1fr;
    }
    
    .categories-grid {
      grid-template-columns: 1fr;
    }
  }
</style> 

