---
import BaseLayout from '../../layouts/BaseLayout.astro';
import type { Game } from '../../types/game';
import fs from 'fs';
import path from 'path';

// 导出getStaticPaths函数用于动态路由
export async function getStaticPaths() {
  // 从JSON文件读取游戏数据
  const gamesDataPath = path.join(process.cwd(), 'src/data/games.json');
  let gamesData: Game[] = [];
  
  try {
    const fileContent = fs.readFileSync(gamesDataPath, 'utf-8');
    gamesData = JSON.parse(fileContent) as Game[];
  } catch (error) {
    console.warn('Unable to read games data file, using default data');
  }

  // 生成路径参数
  const paths = gamesData.map(game => ({
    params: { slug: game.slug }
  }));

  return paths;
}

// 从JSON文件读取游戏数据
const gamesDataPath = path.join(process.cwd(), 'src/data/games.json');
let gamesData: Game[] = [];

try {
  const fileContent = fs.readFileSync(gamesDataPath, 'utf-8');
  gamesData = JSON.parse(fileContent) as Game[];
} catch (error) {
  console.warn('Unable to read games data file');
}

const { slug } = Astro.params;
const game = gamesData.find(g => g.slug === slug);

if (!game) {
  return Astro.redirect('/404');
}

// 获取相关游戏（同分类的其他游戏，增加到4个）
const relatedGames = gamesData
  .filter((gameData: Game) => gameData.slug !== slug && gameData.category === game.category)
  .slice(0, 4)
  .map((gameData: Game) => ({
    slug: gameData.slug,
    title: gameData.title,
    description: gameData.description,
    image: gameData.image || `/images/games/${gameData.slug}.svg`,
    category: gameData.category,
    categoryName: gameData.categoryName,
    difficulty: gameData.difficulty,
    rating: gameData.rating || 4.5,
    playCount: gameData.playCount || 1000
  }));

// 游戏来源检测和标识
function getGameSource(url: string | undefined) {
  // 添加空值检查
  if (!url || typeof url !== 'string') {
    return {
      type: 'unknown',
      name: 'Unknown Source',
      icon: 'fas fa-question-circle',
      color: '#6B7280',
      description: 'Game source information not available',
      developer: 'Unknown Developer'
    };
  }
  
  if (url.includes('github.io') || url.includes('itch.io')) {
    return {
      type: 'opensource',
      name: 'Open Source',
      icon: 'fab fa-github',
      color: '#10B981',
      description: 'This game is from an open source project',
      developer: 'Independent Developer'
    };
  } else if (url.includes('crazygames.com')) {
    return {
      type: 'thirdparty',
      name: 'CrazyGames',
      icon: 'fas fa-external-link-alt',
      color: '#F59E0B',
      description: 'This game is hosted by CrazyGames platform',
      developer: 'CrazyGames Studio'
    };
  } else if (url.includes('miniplay.com')) {
    return {
      type: 'thirdparty',
      name: 'Miniplay',
      icon: 'fas fa-external-link-alt',
      color: '#F59E0B',
      description: 'This game is hosted by Miniplay platform',
      developer: 'Miniplay Studio'
    };
  } else {
    return {
      type: 'thirdparty',
      name: 'External Source',
      icon: 'fas fa-external-link-alt',
      color: '#6B7280',
      description: 'This game is hosted by a third-party provider',
      developer: 'Third-party Developer'
    };
  }
}

const gameSource = getGameSource(game.url);

// 操作说明
const howToPlaySteps = game.howToPlay || [
  'Use mouse to click and interact',
  'Use keyboard arrow keys to move',
  'Follow in-game instructions',
  'Complete challenges to progress'
];

// SEO数据
const seoData = {
  title: `${game.title} - Educational Game | EduGameHQ`,
  description: game.description || `Play ${game.title} online for free. Educational game perfect for learning.`,
  keywords: [game.title.toLowerCase(), `${game.category} games`, "educational games", "free online games"],
  ogImage: game.image || "/images/logo.svg"
};
---

<BaseLayout title={seoData.title} description={seoData.description}>
  <main class="game-detail-page">
    <div class="game-detail-container">
      <!-- 面包屑导航 -->
      <nav class="game-breadcrumb">
        <a href="/">
          <i class="fas fa-home"></i>
          Home
        </a>
        <i class="fas fa-chevron-right"></i>
        <a href={`/${game.category}-games`}>{game.categoryName} Games</a>
        <i class="fas fa-chevron-right"></i>
        <span>{game.title}</span>
      </nav>

      <!-- 游戏标题和基本信息 -->
      <header class="game-header">
        <div class="game-title-section">
          <h1 class="game-title">{game.title}</h1>
          <div class="game-basic-info">
            <span class="info-badge category-badge">
              <i class="fas fa-graduation-cap"></i>
              {game.categoryName}
            </span>
            <span class="info-badge difficulty-badge">
              <i class="fas fa-signal"></i>
              {game.difficulty}
            </span>
          </div>
        </div>
      </header>

      <!-- 主要内容区域 -->
      <div class="game-main-content">
        <!-- 游戏播放器区域 -->
        <div class="game-player-section">
          <div class="game-iframe-container">
            <!-- 加载状态 -->
            <div class="loading-overlay">
              <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading game...</p>
              </div>
            </div>
            
            <!-- 游戏iframe -->
            <iframe 
              src={game.url}
              title={game.title}
              class="game-iframe"
              allowfullscreen
              sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-presentation"
              loading="lazy"
            ></iframe>
            
            <!-- 安全提示覆盖层 -->
            <div class="security-notice">
              <i class="fas fa-shield-alt"></i>
              <span>Secure sandbox environment</span>
            </div>
          </div>
          
          <!-- 游戏控制按钮 -->
          <div class="game-controls">
            <button class="control-btn primary-btn fullscreen-btn">
              <i class="fas fa-expand"></i>
              Fullscreen
            </button>
            <button class="control-btn secondary-btn refresh-btn">
              <i class="fas fa-redo"></i>
              Restart
            </button>
            <button class="control-btn secondary-btn favorite-btn">
              <i class="far fa-heart"></i>
              Favorite
            </button>
            <button class="control-btn secondary-btn share-btn">
              <i class="fas fa-share"></i>
              Share
            </button>
          </div>
        </div>

        <!-- 游戏信息侧边栏 -->
        <div class="game-info-sidebar">
          <!-- 游戏介绍 -->
          <div class="info-card game-description-card">
            <h3 class="info-title">
              <i class="fas fa-info-circle"></i>
              About This Game
            </h3>
            <p class="game-description">{game.description}</p>
          </div>

          <!-- 游戏特色 -->
          <div class="info-card">
            <h3 class="info-title">
              <i class="fas fa-star"></i>
              Game Features
            </h3>
            <ul class="features-list">
              {game.gameFeatures ? game.gameFeatures.map(feature => (
                <li class="feature-item">
                  <i class="fas fa-check-circle"></i>
                  <span>{feature}</span>
                </li>
              )) : [
                'Interactive gameplay',
                'Educational content', 
                'Progress tracking',
                'Kid-friendly interface'
              ].map(feature => (
                <li class="feature-item">
                  <i class="fas fa-check-circle"></i>
                  <span>{feature}</span>
                </li>
              ))}
            </ul>
          </div>

          <!-- 操作说明 -->
          <div class="info-card">
            <h3 class="info-title">
              <i class="fas fa-gamepad"></i>
              How to Play
            </h3>
            <ol class="how-to-play-list">
              {howToPlaySteps.map((step, index) => (
                <li class="play-step">
                  <div class="step-number">{index + 1}</div>
                  <span class="step-text">{step}</span>
                </li>
              ))}
            </ol>
          </div>

          <!-- 开发者信息 -->
          <div class="info-card">
            <h3 class="info-title">
              <i class="fas fa-code"></i>
              Developer Info
            </h3>
            <div class="developer-info">
              <div class="developer-item">
                <span class="developer-label">Developer:</span>
                <span class="developer-value">{gameSource.developer}</span>
              </div>
              <div class="developer-item">
                <span class="developer-label">Platform:</span>
                <span class="developer-value">{gameSource.name}</span>
              </div>
              <div class="developer-item">
                <span class="developer-label">Type:</span>
                <span class="developer-value">{gameSource.type === 'opensource' ? 'Open Source' : 'Commercial'}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 相关游戏推荐 -->
      <section class="related-games-section">
        <h2 class="section-title">
          <i class="fas fa-gamepad"></i>
          More {game.categoryName} Games
        </h2>
        <div class="related-games-grid">
          {relatedGames.map((relatedGame) => (
            <div class="game-card">
              <div class="game-image-container">
                <img 
                  src={relatedGame.image} 
                  alt={relatedGame.title}
                  class="game-image"
                  loading="lazy"
                />
                <div class="game-overlay">
                  <div class="popularity-badge">
                    {relatedGame.playCount > 5000 ? '🔥' : relatedGame.playCount > 1000 ? '⭐' : ''} 
                    {relatedGame.playCount > 1000 ? `${Math.floor(relatedGame.playCount / 1000)}K` : relatedGame.playCount}
                  </div>
                  <a href={`/games/${relatedGame.slug}`} class="play-button">
                    <i class="fas fa-play"></i>
                  </a>
                </div>
              </div>
              <div class="game-info">
                <h3 class="game-title">{relatedGame.title}</h3>
                <p class="game-description">{relatedGame.description}</p>
                <div class="game-tags">
                  <span class="category-tag">{relatedGame.categoryName}</span>
                  <span class="difficulty-tag">{relatedGame.difficulty}</span>
                </div>
              </div>
            </div>
          ))}
        </div>
      </section>
    </div>
  </main>

  <style>
    .game-detail-page {
      min-height: 100vh;
      background: linear-gradient(135deg, #FEFCFB 0%, #F8F6F3 100%);
      padding: 2rem 0;
    }

    .game-detail-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    /* 面包屑导航 */
    .game-breadcrumb {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 2rem;
      font-size: 0.9rem;
      color: #6B7280;
    }

    .game-breadcrumb a {
      color: #6366F1;
      text-decoration: none;
      transition: color 0.3s ease;
    }

    .game-breadcrumb a:hover {
      color: #4F46E5;
    }

    .game-breadcrumb i {
      font-size: 0.8rem;
    }

    /* 游戏标题区域 */
    .game-header {
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      border: 1px solid #F3F4F6;
    }

    .game-title {
      font-size: 2.5rem;
      font-weight: 800;
      color: #1F2937;
      margin: 0 0 1rem 0;
      font-family: 'Space Grotesk', sans-serif;
    }

    .game-basic-info {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .info-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      color: white;
    }

    .category-badge {
      background: linear-gradient(135deg, #EA580C, #DC2626);
    }

    .difficulty-badge {
      background: linear-gradient(135deg, #10B981, #059669);
    }

    /* 主要内容区域 */
    .game-main-content {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 2rem;
      margin-bottom: 3rem;
    }

    /* 游戏播放器区域 */
    .game-player-section {
      background: white;
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      border: 1px solid #F3F4F6;
    }

    .game-iframe-container {
      position: relative;
      width: 100%;
      height: 600px;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 1.5rem;
      background: #F3F4F6;
    }

    .game-iframe {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 12px;
    }

    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 2;
    }

    .loading-spinner i {
      font-size: 2rem;
      color: #6366F1;
      margin-bottom: 1rem;
    }

    .security-notice {
      position: absolute;
      bottom: 1rem;
      right: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: rgba(16, 185, 129, 0.9);
      color: white;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    /* 游戏控制按钮 */
    .game-controls {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .control-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .primary-btn {
      background: linear-gradient(135deg, #6366F1, #4F46E5);
      color: white;
    }

    .primary-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
    }

    .secondary-btn {
      background: #F3F4F6;
      color: #6B7280;
      border: 1px solid #E5E7EB;
    }

    .secondary-btn:hover {
      background: #E5E7EB;
      color: #374151;
    }

    /* 游戏信息侧边栏 */
    .game-info-sidebar {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .info-card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      border: 1px solid #F3F4F6;
    }

    .info-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.125rem;
      font-weight: 700;
      color: #1F2937;
      margin: 0 0 1rem 0;
    }

    .info-title i {
      color: #6366F1;
    }

    .game-description {
      color: #6B7280;
      line-height: 1.6;
      margin: 0;
    }

    /* 游戏特色列表 */
    .features-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .feature-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem 0;
      color: #374151;
    }

    .feature-item i {
      color: #10B981;
      font-size: 0.875rem;
    }

    /* 操作说明列表 */
    .how-to-play-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .play-step {
      display: flex;
      align-items: flex-start;
      gap: 1rem;
      padding: 0.75rem 0;
      color: #374151;
    }

    .step-number {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      background: linear-gradient(135deg, #6366F1, #4F46E5);
      color: white;
      border-radius: 50%;
      font-size: 0.75rem;
      font-weight: 700;
      flex-shrink: 0;
    }

    .step-text {
      line-height: 1.5;
    }

    /* 开发者信息 */
    .developer-info {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .developer-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .developer-label {
      color: #6B7280;
      font-weight: 500;
    }

    .developer-value {
      color: #1F2937;
      font-weight: 600;
    }

    /* 相关游戏推荐 */
    .related-games-section {
      margin-top: 3rem;
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.5rem;
      font-weight: 700;
      color: #1F2937;
      margin: 0 0 1.5rem 0;
    }

    .section-title i {
      color: #6366F1;
    }

    .related-games-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
    }

    /* 游戏卡片样式 */
    .game-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      border: 1px solid #F3F4F6;
      transition: all 0.3s ease;
    }

    .game-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }

    .game-image-container {
      position: relative;
      height: 200px;
      overflow: hidden;
    }

    .game-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }

    .game-card:hover .game-image {
      transform: scale(1.05);
    }

    .game-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .game-card:hover .game-overlay {
      opacity: 1;
    }

    .popularity-badge {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      padding: 0.375rem 0.75rem;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .play-button {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #6366F1, #4F46E5);
      color: white;
      border-radius: 50%;
      text-decoration: none;
      font-size: 1.25rem;
      transition: all 0.3s ease;
    }

    .play-button:hover {
      transform: scale(1.1);
      background: linear-gradient(135deg, #4F46E5, #3730A3);
    }

    .game-info {
      padding: 1.25rem;
    }

    .game-info .game-title {
      font-size: 1.125rem;
      font-weight: 700;
      color: #1F2937;
      margin: 0 0 0.5rem 0;
      line-height: 1.4;
    }

    .game-info .game-description {
      color: #6B7280;
      font-size: 0.875rem;
      line-height: 1.5;
      margin: 0 0 1rem 0;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .game-info .game-tags {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .category-tag {
      padding: 0.25rem 0.5rem;
      background: linear-gradient(135deg, #EA580C, #DC2626);
      color: white;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .difficulty-tag {
      padding: 0.25rem 0.5rem;
      background: linear-gradient(135deg, #10B981, #059669);
      color: white;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    /* 响应式设计 */
    @media (max-width: 1024px) {
      .game-main-content {
        grid-template-columns: 1fr;
      }
      
      .game-title {
        font-size: 2rem;
      }
    }

    @media (max-width: 768px) {
      .game-header {
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
      }
      
      .game-iframe-container {
        height: 400px;
      }
      
      .game-controls {
        justify-content: center;
      }
      
      .related-games-grid {
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      }
    }

    @media (max-width: 640px) {
      .game-detail-container {
        padding: 0 0.5rem;
      }
      
      .game-title {
        font-size: 1.75rem;
      }
      
      .game-iframe-container {
        height: 300px;
      }
      
      .control-btn {
        padding: 0.5rem 1rem;
        font-size: 0.8rem;
      }
    }
  </style>

  <script>
    // 游戏加载处理
    document.addEventListener('DOMContentLoaded', function() {
      const iframe = document.querySelector('.game-iframe');
      const loadingOverlay = document.querySelector('.loading-overlay');
      
      if (iframe && loadingOverlay) {
        iframe.addEventListener('load', function() {
          setTimeout(() => {
            loadingOverlay.style.opacity = '0';
            setTimeout(() => {
              loadingOverlay.style.display = 'none';
            }, 300);
          }, 1000);
        });
      }

      // 全屏功能
      const fullscreenBtn = document.querySelector('.fullscreen-btn');
      if (fullscreenBtn) {
        fullscreenBtn.addEventListener('click', function() {
          const container = document.querySelector('.game-iframe-container');
          if (container.requestFullscreen) {
            container.requestFullscreen();
          }
        });
      }

      // 重启游戏
      const refreshBtn = document.querySelector('.refresh-btn');
      if (refreshBtn && iframe) {
        refreshBtn.addEventListener('click', function() {
          iframe.src = iframe.src;
        });
      }

      // 收藏功能
      const favoriteBtn = document.querySelector('.favorite-btn');
      if (favoriteBtn) {
        favoriteBtn.addEventListener('click', function() {
          const icon = favoriteBtn.querySelector('i');
          if (icon.classList.contains('far')) {
            icon.classList.remove('far');
            icon.classList.add('fas');
            favoriteBtn.style.color = '#EF4444';
          } else {
            icon.classList.remove('fas');
            icon.classList.add('far');
            favoriteBtn.style.color = '';
          }
        });
      }

      // 分享功能
      const shareBtn = document.querySelector('.share-btn');
      if (shareBtn) {
        shareBtn.addEventListener('click', function() {
          if (navigator.share) {
            navigator.share({
              title: document.title,
              url: window.location.href
            });
          } else {
            navigator.clipboard.writeText(window.location.href);
            alert('Game link copied to clipboard!');
          }
        });
      }
    });
  </script>
</BaseLayout> 