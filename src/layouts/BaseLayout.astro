---
import { getPageSEO, generateStructuredData, getKeywordsString, getOGImageUrl } from '../data/seo-config';
import fs from 'fs';
import path from 'path';
// å¤šè¯­è¨€æ”¯æŒå¯¼å…¥
import { getLanguageFromPath, getTranslations, t, getLocalizedPath, isRTL, getLanguageInfo, getLanguageSwitchLinks, type LanguageCode } from '../i18n/utils';
import { defaultLanguage, languages } from '../i18n/config';
// å¯¼å…¥æ ·å¼æ–‡ä»¶
import '../styles/language-switcher.css';
import '../styles/navbar.css';
import '../styles/footer.css';

export interface Props {
  title?: string;
  description?: string;
  bodyClass?: string;
  gameData?: any; // æ¸¸æˆé¡µé¢çš„æ¸¸æˆæ•°æ®
  lang?: LanguageCode; // å¯é€‰çš„è¯­è¨€å‚æ•°
}

const { title, description, bodyClass = "", gameData, lang } = Astro.props;

// è·å–å½“å‰é¡µé¢è·¯å¾„ï¼Œç”¨äºå¯¼èˆªé«˜äº®å’ŒSEOé…ç½®
const currentPath = Astro.url.pathname;

// å¤šè¯­è¨€é…ç½®
const currentLang = lang || getLanguageFromPath(currentPath);
const langInfo = getLanguageInfo(currentLang);
const translations = await getTranslations(currentLang);
const isRTLLang = isRTL(currentLang);

// è·å–è¯­è¨€åˆ‡æ¢é“¾æ¥
const languageSwitchLinks = getLanguageSwitchLinks(currentPath);

// è·å–SEOé…ç½®
const seoConfig = getPageSEO(currentPath);
const pageTitle = title || seoConfig.title;
const pageDescription = description || seoConfig.description;
const pageKeywords = getKeywordsString(currentPath);
const ogImageUrl = getOGImageUrl(currentPath);
const structuredData = generateStructuredData(currentPath, gameData);

// æ„å»ºå®Œæ•´çš„é¡µé¢URL
const canonicalUrl = new URL(currentPath, Astro.site || 'https://www.edugamehq.com').toString();

// å®šä¹‰é¡µé¢åˆ†ç±»å’Œå±‚çº§ç»“æ„ - æ”¯æŒå¤šè¯­è¨€
const pageStructure = {
  categories: {
    '/math-games': { 
      name: t(translations, 'categories.math-games', 'Math Games'), 
      icon: 'fas fa-calculator', 
      color: 'math' 
    },
    '/science-games': { 
      name: t(translations, 'categories.science-games', 'Science Games'), 
      icon: 'fas fa-flask', 
      color: 'science' 
    },
    '/language-games': { 
      name: t(translations, 'categories.language-games', 'Language Games'), 
      icon: 'fas fa-book-open', 
      color: 'language' 
    },
    '/puzzle-games': { 
      name: t(translations, 'categories.puzzle-games', 'Puzzle Games'), 
      icon: 'fas fa-puzzle-piece', 
      color: 'puzzle' 
    },
    '/sports-games': { 
      name: t(translations, 'categories.sports-games', 'Sports Games'), 
      icon: 'fas fa-futbol', 
      color: 'sports' 
    },
    '/art-games': { 
      name: t(translations, 'categories.art-games', 'Art Games'), 
      icon: 'fas fa-palette', 
      color: 'art' 
    }
  },
  special: {
    '/trending': { 
      name: t(translations, 'nav.trending', 'Trending'), 
      icon: 'fas fa-fire', 
      color: 'trending' 
    },
    '/recently-played': { 
      name: t(translations, 'nav.recent', 'Recently Played'), 
      icon: 'fas fa-history', 
      color: 'recent' 
    },
    '/new-games': { 
      name: t(translations, 'nav.new', 'New Games'), 
      icon: 'fas fa-plus-circle', 
      color: 'new' 
    }
  },
  system: {
    '/favorites': { 
      name: t(translations, 'nav.favorites', 'Favorites'), 
      icon: 'fas fa-heart', 
      color: 'favorites' 
    },
    '/search': { 
      name: t(translations, 'nav.search', 'Search'), 
      icon: 'fas fa-search', 
      color: 'search' 
    }
  },
  support: {
    '/privacy-policy': { 
      name: t(translations, 'nav.privacy', 'Privacy Policy'), 
      icon: 'fas fa-shield-alt', 
      color: 'support' 
    },
    '/terms-of-service': { 
      name: t(translations, 'nav.terms', 'Terms of Service'), 
      icon: 'fas fa-file-contract', 
      color: 'support' 
    },
    '/help': { 
      name: t(translations, 'nav.help', 'Help & Support'), 
      icon: 'fas fa-life-ring', 
      color: 'support' 
    },
    '/about': { 
      name: t(translations, 'nav.about', 'About'), 
      icon: 'fas fa-info-circle', 
      color: 'support' 
    }
  }
};

// ç¡®å®šå½“å‰é¡µé¢ç±»å‹å’Œä¿¡æ¯
const isHomePage = currentPath === '/';

// ä¿®å¤è·¯å¾„åŒ¹é…é—®é¢˜ - ç¡®ä¿åœ¨æ„å»ºæ—¶ä¹Ÿèƒ½æ­£ç¡®åŒ¹é…
const cleanPath = currentPath.endsWith('/') ? currentPath.slice(0, -1) : currentPath;
const normalizedPath = cleanPath || currentPath;

const currentCategory = (pageStructure.categories as Record<string, any>)[normalizedPath] || (pageStructure.categories as Record<string, any>)[currentPath];
const currentSpecialPage = (pageStructure.special as Record<string, any>)[normalizedPath] || (pageStructure.special as Record<string, any>)[currentPath];
const currentSystemPage = (pageStructure.system as Record<string, any>)[normalizedPath] || (pageStructure.system as Record<string, any>)[currentPath];
const currentSupportPage = (pageStructure.support as Record<string, any>)[normalizedPath] || (pageStructure.support as Record<string, any>)[currentPath];
const isGamePage = currentPath.startsWith('/games/');

// æ„å»ºé¢åŒ…å±‘å¯¼èˆª - å¤šè¯­è¨€æ”¯æŒ
const breadcrumbs = [];
if (!isHomePage) {
  breadcrumbs.push({ 
    name: t(translations, 'nav.home', 'Home'), 
    url: getLocalizedPath('/', currentLang), 
    icon: 'fas fa-home' 
  });
  
  if (currentCategory) {
    breadcrumbs.push({ 
      name: t(translations, 'nav.categories', 'Categories'), 
      url: '#', 
      icon: 'fas fa-gamepad', 
      isDropdown: true 
    });
    breadcrumbs.push({ 
      name: currentCategory.name, 
      url: getLocalizedPath(currentPath, currentLang), 
      icon: currentCategory.icon,
      color: currentCategory.color,
      isCurrent: true 
    });
  } else if (currentSpecialPage) {
    breadcrumbs.push({ 
      name: t(translations, 'nav.categories', 'Categories'), 
      url: '#', 
      icon: 'fas fa-gamepad', 
      isDropdown: true 
    });
    breadcrumbs.push({ 
      name: currentSpecialPage.name, 
      url: getLocalizedPath(currentPath, currentLang), 
      icon: currentSpecialPage.icon,
      color: currentSpecialPage.color,
      isCurrent: true 
    });
  } else if (currentSystemPage) {
    // ç³»ç»Ÿé¡µé¢é¢åŒ…å±‘ï¼ˆå¦‚æ”¶è—ã€æœç´¢ç­‰ï¼‰
    breadcrumbs.push({ 
      name: currentSystemPage.name, 
      url: getLocalizedPath(currentPath, currentLang), 
      icon: currentSystemPage.icon,
      color: currentSystemPage.color,
      isCurrent: true 
    });
  } else if (currentSupportPage) {
    // Supporté¡µé¢é¢åŒ…å±‘
    breadcrumbs.push({ 
      name: t(translations, 'support', 'Support'), 
      url: '#', 
      icon: 'fas fa-life-ring', 
      color: 'support',
      isDropdown: true 
    });
    breadcrumbs.push({ 
      name: currentSupportPage.name, 
      url: getLocalizedPath(currentPath, currentLang), 
      icon: currentSupportPage.icon,
      color: currentSupportPage.color,
      isCurrent: true 
    });
  } else if (isGamePage) {
    // æ¸¸æˆé¡µé¢é¢åŒ…å±‘ - éœ€è¦æ ¹æ®æ¸¸æˆæ‰€å±åˆ†ç±»æ¥ç¡®å®š
    breadcrumbs.push({ 
      name: t(translations, 'nav.categories', 'Categories'), 
      url: '#', 
      icon: 'fas fa-gamepad', 
      isDropdown: true 
    });
    breadcrumbs.push({ 
      name: t(translations, 'game', 'Games'), 
      url: getLocalizedPath('/', currentLang), 
      icon: 'fas fa-gamepad' 
    });
  }
}

// æ·»åŠ è¯¦ç»†çš„é¢åŒ…å±‘è°ƒè¯•ä¿¡æ¯
console.log('ğŸ é¢åŒ…å±‘è°ƒè¯•ä¿¡æ¯:');
console.log('- å½“å‰è·¯å¾„:', currentPath);
console.log('- å½“å‰è¯­è¨€:', currentLang);
console.log('- æ˜¯å¦é¦–é¡µ:', isHomePage);
console.log('- å½“å‰åˆ†ç±»:', currentCategory);
console.log('- é¢åŒ…å±‘æ•°ç»„é•¿åº¦:', breadcrumbs.length);
console.log('- é¢åŒ…å±‘å†…å®¹:', breadcrumbs);

// æ·»åŠ é¡µé¢ç»“æ„è°ƒè¯•ä¿¡æ¯
console.log('ğŸ“‹ é¡µé¢ç»“æ„è°ƒè¯•ä¿¡æ¯:');
console.log('- åˆ†ç±»æ•°é‡:', Object.keys(pageStructure.categories).length);
console.log('- åˆ†ç±»å†…å®¹:', pageStructure.categories);
console.log('- ç‰¹æ®Šé¡µé¢æ•°é‡:', Object.keys(pageStructure.special).length);
console.log('- ç‰¹æ®Šé¡µé¢å†…å®¹:', pageStructure.special);

// è¯»å–games.jsonæ•°æ®ç”¨äºå®¢æˆ·ç«¯
let gamesData = [];
try {
  const gamesDataPath = path.join(process.cwd(), 'src/data/games.json');
  const fileContent = fs.readFileSync(gamesDataPath, 'utf-8');
  gamesData = JSON.parse(fileContent);
} catch (error) {
  console.warn('Unable to read games data file:', error);
}
---

<!DOCTYPE html>
<html lang={currentLang} dir={isRTLLang ? 'rtl' : 'ltr'}>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- é¡µé¢æ ‡é¢˜å’Œæè¿° -->
  <title>{pageTitle}</title>
  <meta name="description" content={pageDescription}>
  
  <!-- SEOå…³é”®è¯ -->
  <meta name="keywords" content={pageKeywords}>
  
  <!-- å…¶ä»–SEOå…ƒæ ‡ç­¾ -->
  <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
  <meta name="author" content="EduGameHQ">
  <meta name="language" content={langInfo.name}>
  <meta name="revisit-after" content="7 days">
  <meta name="distribution" content="global">
  <meta name="rating" content="general">
  
  <!-- åœ°ç†ä½ç½®æ ‡ç­¾ï¼ˆå…¨çƒæ•™è‚²å¹³å°ï¼‰-->
  <meta name="geo.region" content="US">
  <meta name="geo.placename" content="Global">
  <meta name="ICBM" content="39.7392, -104.9903">
  
  <!-- æ•™è‚²ç›¸å…³METAæ ‡ç­¾ -->
  <meta name="educational-level" content="K-12">
  <meta name="educational-audience" content="student">
  <meta name="educational-subject" content="mathematics,science,language arts,computer science,physical education,arts">
  
  <!-- Favicon - ä½¿ç”¨æ–°è®¾è®¡çš„LOGO -->
  <link rel="icon" type="image/svg+xml" href="/images/logo/favicon.ico">
      <link rel="icon" type="image/png" sizes="32x32" href="/images/logo/edugamehq-icon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/logo/edugamehq-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/logo/edugamehq-icon.png">
  <link rel="manifest" href="/site.webmanifest">
  
  <!-- Canonical URL -->
  <link rel="canonical" href={canonicalUrl}>
  
  <!-- å¤šè¯­è¨€Alternate hreflangæ ‡ç­¾ -->
  {languageSwitchLinks.map(link => (
    <link rel="alternate" hreflang={link.code} href={new URL(link.url, Astro.site || 'https://www.edugamehq.com').toString()}>
  ))}
  <link rel="alternate" hreflang="x-default" href={new URL(getLocalizedPath(currentPath, defaultLanguage), Astro.site || 'https://www.edugamehq.com').toString()}>
  
  <!-- Fonts - ä¼˜åŒ–åŠ è½½ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous">
  
  <!-- Open Graph Meta Tags -->
  <meta property="og:title" content={pageTitle}>
  <meta property="og:description" content={pageDescription}>
  <meta property="og:type" content={isGamePage ? "game" : "website"}>
  <meta property="og:url" content={canonicalUrl}>
  <meta property="og:image" content={new URL(ogImageUrl, Astro.site || 'https://www.edugamehq.com').toString()}>
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:image:alt" content={`${pageTitle} - EduGameHQ Educational Games`}>
  <meta property="og:site_name" content="EduGameHQ">
  <meta property="og:locale" content={currentLang === 'en' ? 'en_US' : `${currentLang}_${currentLang.toUpperCase()}`}>
  
  <!-- Twitter Card Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@EduGameHQ">
  <meta name="twitter:creator" content="@EduGameHQ">
  <meta name="twitter:title" content={pageTitle}>
  <meta name="twitter:description" content={pageDescription}>
  <meta name="twitter:image" content={new URL(ogImageUrl, Astro.site || 'https://www.edugamehq.com').toString()}>
  <meta name="twitter:image:alt" content={`${pageTitle} - EduGameHQ Educational Games`}>
  
  <!-- Facebook Meta Tags -->
  <meta property="fb:app_id" content="your-facebook-app-id">
  
  <!-- Pinterest Meta Tags -->
  <meta name="pinterest-rich-pin" content="true">
  
  <!-- LinkedIn Meta Tags -->
  <meta property="linkedin:owner" content="EduGameHQ">
  
  <!-- Preload critical resources -->
      <link rel="preload" href="/images/logo/edugamehq-logo.png" as="image">
    <link rel="preload" href="/images/logo/edugamehq-icon.png" as="image">
  <link rel="preload" href={ogImageUrl} as="image">
  
  <!-- DNS Prefetch for external resources -->
  <link rel="dns-prefetch" href="//fonts.googleapis.com">
  <link rel="dns-prefetch" href="//fonts.gstatic.com">
  <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
  <link rel="dns-prefetch" href="//www.googletagmanager.com">
  
  <!-- Structured Data (JSON-LD) -->
  {structuredData && (
    <script type="application/ld+json" set:html={JSON.stringify(structuredData)} is:inline />
  )}
  
  <!-- Additional structured data for educational content -->
  <script type="application/ld+json" is:inline>
  {
    "@context": "https://schema.org",
    "@type": "EducationalOrganization",
    "name": "EduGameHQ",
    "alternateName": "Educational Games Headquarters",
    "description": "Free educational games platform for kids aged 6-18",
    "url": "https://www.edugamehq.com",
          "logo": "https://www.edugamehq.com/images/logo/edugamehq-logo.png",
    "sameAs": [
      "https://twitter.com/EduGameHQ",
      "https://facebook.com/EduGameHQ",
      "https://youtube.com/EduGameHQ"
    ],
    "contactPoint": {
      "@type": "ContactPoint",
      "contactType": "customer support",
      "email": "support@edugamehq.com"
    },
    "educationalCredentialAwarded": "None",
    "hasOfferCatalog": {
      "@type": "OfferCatalog",
      "name": "Educational Games",
      "itemListElement": [
        {
          "@type": "OfferCategory",
          "name": "Math Games"
        },
        {
          "@type": "OfferCategory", 
          "name": "Science Games"
        },
        {
          "@type": "OfferCategory",
          "name": "Language Games"
        },
        {
          "@type": "OfferCategory",
          "name": "Coding Games"
        },
        {
          "@type": "OfferCategory",
          "name": "Puzzle Games"
        },
        {
          "@type": "OfferCategory",
          "name": "Sports Games"
        },
        {
          "@type": "OfferCategory",
          "name": "Art Games"
        }
      ]
    }
  }
  </script>
  
  <!-- Google Analytics 4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-RR1NHJ49F5" is:inline></script>
  <script is:inline>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-RR1NHJ49F5', {
      page_title: document.title,
      page_location: window.location.href,
      content_group1: 'Educational Games',
      custom_map: {
        'dimension1': 'page_category',
        'dimension2': 'user_type'
      }
    });
  </script>
  
  <!-- Google Search Console Verification -->
  <!-- è¯·å°†ä¸‹é¢çš„éªŒè¯ä»£ç æ›¿æ¢ä¸ºGoogle Search Consoleæä¾›çš„çœŸå®éªŒè¯ä»£ç  -->
  <meta name="google-site-verification" content="è¯·åœ¨æ­¤å¤„ç²˜è´´Google Search Consoleæä¾›çš„éªŒè¯ä»£ç ">
  
  <!-- Bing Webmaster Tools Verification -->
  <meta name="msvalidate.01" content="EB5E4EA52C1CCD23BB71B259934EAE24">
  
  <!-- Yandex Verification -->
  <meta name="yandex-verification" content="60fb28260cdeec35">
  
  <!-- Theme Color for mobile browsers -->
  <meta name="theme-color" content="#F59E0B">
  <meta name="msapplication-TileColor" content="#F59E0B">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  
  <!-- æ€§èƒ½ä¼˜åŒ– -->
  <link rel="dns-prefetch" href="//fonts.googleapis.com">
  <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
  <link rel="dns-prefetch" href="//www.googletagmanager.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  
  <!-- æ¸¸æˆç»Ÿè®¡ç®¡ç†å™¨ - å…¨å±€åŠ è½½ -->
  <script src="/js/game-stats-manager.js" defer is:inline></script>
  
  <!-- å…¨å±€gamesæ•°æ® - ä¾›å®¢æˆ·ç«¯JavaScriptä½¿ç”¨ -->
  <script define:vars={{ gamesData, currentLang, translations }} is:inline>
    // è®¾ç½®å…¨å±€æ¸¸æˆæ•°æ®å’Œå¤šè¯­è¨€æ•°æ®
    window.GAMES_DATA = gamesData || [];
    window.CURRENT_LANG = currentLang;
    window.TRANSLATIONS = translations;
    console.log('ğŸŒ GAMES_DATAå·²è®¾ç½®ï¼Œæ¸¸æˆæ•°é‡:', window.GAMES_DATA.length);
    console.log('ğŸŒ å½“å‰è¯­è¨€:', window.CURRENT_LANG);
    console.log('ğŸ“Š GAMES_DATAå†…å®¹æ ·ä¾‹:', window.GAMES_DATA.slice(0, 2));
  </script>
  
  <!-- FontAwesomeæ ·å¼è¡¨ -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <!-- RTLæ ·å¼æ”¯æŒ -->
  {isRTLLang && (
    <style>
      body { direction: rtl; }
      .search-container { order: -1; }
      .nav-actions { order: 1; }
      .breadcrumb-separator { transform: scaleX(-1); }
    </style>
  )}
  
</head>

<body class={`min-h-screen ${bodyClass} ${isRTLLang ? 'rtl' : 'ltr'}`}>
  <!-- Skip to main content for accessibility -->
  <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-gold-500 text-white px-4 py-2 rounded-lg z-50">
    {t(translations, 'common.skip_to_content', 'Skip to main content')}
  </a>
  
  <!-- é¡µé¢å†…å®¹ -->
  <div class="flex flex-col min-h-screen">
    <!-- å¯¼èˆªæ  -->
    <header class="navbar">
      <div class="nav-container">
        <!-- Logo -->
        <div class="nav-logo">
          <a href={getLocalizedPath('/', currentLang)} class="logo-link">
            <img src="/images/logo/edugamehq-logo.png" alt="EduGameHQ Logo" width="300" height="80" />
          </a>
        </div>
        
        <!-- æ™ºèƒ½é¢åŒ…å±‘å¯¼èˆª -->
        <nav class="nav-menu" aria-label="Main navigation">
          {breadcrumbs.length === 0 ? (
            <!-- é¦–é¡µå¯¼èˆª -->
            <div class="nav-breadcrumbs">
              <a href={getLocalizedPath('/', currentLang)} class="nav-link current" aria-current="page">
                <i class="fas fa-home"></i>
                {t(translations, 'nav.home', 'Home')}
              </a>
              <div class="nav-dropdown">
                <button class="nav-link dropdown-trigger" id="categoriesDropdown">
                  <i class="fas fa-gamepad"></i>
                  {t(translations, 'nav.categories', 'Categories')}
                  <i class="fas fa-chevron-down dropdown-arrow"></i>
                </button>
                <div class="dropdown-menu" id="categoriesMenu">
                  <!-- æ¸¸æˆåˆ†ç±» -->
                  {Object.entries(pageStructure.categories).map(([path, info]) => (
                    <a href={getLocalizedPath(path, currentLang)} class={`dropdown-item ${info.color}`}>
                      <i class={info.icon}></i>
                      {info.name}
                    </a>
                  ))}
                  <!-- åˆ†éš”çº¿ -->
                  <hr class="dropdown-divider">
                  <!-- ç‰¹æ®Šé¡µé¢ -->
                  {Object.entries(pageStructure.special).map(([path, info]) => (
                    <a href={getLocalizedPath(path, currentLang)} class={`dropdown-item ${info.color}`}>
                      <i class={info.icon}></i>
                      {info.name}
                    </a>
                  ))}
                </div>
              </div>
            </div>
          ) : (
            <!-- é¢åŒ…å±‘å¯¼èˆª -->
            <div class="nav-breadcrumbs">
              {breadcrumbs.map((crumb, index) => (
                <div class="breadcrumb-item">
                  {crumb.isDropdown ? (
                    <div class="nav-dropdown">
                      <button class="nav-link dropdown-trigger" id={crumb.name === t(translations, 'nav.categories', 'Categories') ? 'categoriesDropdown' : crumb.name === t(translations, 'support', 'Support') ? 'supportDropdown' : 'defaultDropdown'}>
                        <i class={crumb.icon}></i>
                        {crumb.name}
                        <i class="fas fa-chevron-down dropdown-arrow"></i>
                      </button>
                      <div class="dropdown-menu" id={crumb.name === t(translations, 'nav.categories', 'Categories') ? 'categoriesMenu' : crumb.name === t(translations, 'support', 'Support') ? 'supportMenu' : 'defaultMenu'}>
                        {crumb.name === t(translations, 'nav.categories', 'Categories') ? (
                          <>
                        <!-- æ¸¸æˆåˆ†ç±» -->
                        {Object.entries(pageStructure.categories).map(([path, info]) => (
                          <a href={getLocalizedPath(path, currentLang)} class={`dropdown-item ${info.color} ${currentPath === path ? 'active' : ''}`}>
                            <i class={info.icon}></i>
                            {info.name}
                          </a>
                        ))}
                        <!-- åˆ†éš”çº¿ -->
                        <hr class="dropdown-divider">
                        <!-- ç‰¹æ®Šé¡µé¢ -->
                        {Object.entries(pageStructure.special).map(([path, info]) => (
                          <a href={getLocalizedPath(path, currentLang)} class={`dropdown-item ${info.color} ${currentPath === path ? 'active' : ''}`}>
                            <i class={info.icon}></i>
                            {info.name}
                          </a>
                        ))}
                          </>
                        ) : crumb.name === t(translations, 'support', 'Support') ? (
                          <>
                            <!-- Supporté¡µé¢ -->
                            {Object.entries(pageStructure.support).map(([path, info]) => (
                              <a href={getLocalizedPath(path, currentLang)} class={`dropdown-item ${info.color} ${currentPath === path ? 'active' : ''}`}>
                                <i class={info.icon}></i>
                                {info.name}
                              </a>
                            ))}
                          </>
                        ) : null}
                      </div>
                    </div>
                  ) : (
                    <a href={crumb.url} class={`nav-link ${crumb.isCurrent ? 'current' : ''} ${crumb.color || ''}`}>
                      <i class={crumb.icon}></i>
                      {crumb.name}
                    </a>
                  )}
                  {index < breadcrumbs.length - 1 && (
                    <i class="fas fa-chevron-right breadcrumb-separator"></i>
                  )}
                </div>
              ))}
            </div>
          )}
        </nav>
        
        <!-- æœç´¢åŒºåŸŸ -->
        <div class="search-container">
          <div class="search-wrapper">
            <i class="fas fa-search search-icon"></i>
            <input 
              type="text" 
              class="search-box" 
              placeholder={t(translations, 'search.placeholder', 'Search educational games...')}
              autocomplete="off"
            />
            <button type="button" class="search-button" onclick="performSearch()">
              <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>
        
        <!-- å³ä¾§æŒ‰é’®ç»„ -->
        <div class="nav-actions">
          <!-- è¯­è¨€åˆ‡æ¢å™¨ -->
          <div class="nav-dropdown language-switcher">
            <button class="nav-btn language-btn dropdown-trigger" id="languageDropdown" title={t(translations, 'language.switch', 'Switch Language')}>
              <span class="language-flag">{langInfo.flag}</span>
              <span class="language-code">{currentLang.toUpperCase()}</span>
              <i class="fas fa-chevron-down dropdown-arrow"></i>
            </button>
            <div class="dropdown-menu language-menu" id="languageMenu">
              {languageSwitchLinks.map(link => (
                <a href={link.url} class={`dropdown-item language-item ${link.code === currentLang ? 'active' : ''}`} dir={link.dir}>
                  <span class="language-flag">{link.flag}</span>
                  <span class="language-name">{link.nativeName}</span>
                  {link.code === currentLang && <i class="fas fa-check"></i>}
                </a>
              ))}
            </div>
          </div>
          
          <a href={getLocalizedPath('/favorites', currentLang)} class={`nav-btn favorites-btn ${currentPath === '/favorites' ? 'current' : ''}`} title={t(translations, 'nav.favorites', 'Favorites')}>
            <i class="fas fa-heart"></i>
            <span class="nav-btn-text">{t(translations, 'nav.favorites', 'Favorites')}</span>
          </a>
          <button class="nav-btn random-btn" onclick="playRandomGame()" title={t(translations, 'game.random', 'Random Game')}>
            <i class="fas fa-dice"></i>
            <span class="nav-btn-text">{t(translations, 'game.random', 'Random')}</span>
          </button>
          
          <!-- ç§»åŠ¨ç«¯èœå•æŒ‰é’® -->
          <button class="mobile-menu-btn" id="mobileMenuBtn">
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
          </button>
        </div>
      </div>
      
      <!-- ç§»åŠ¨ç«¯èœå• -->
      <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-content">
          <a href={getLocalizedPath('/', currentLang)} class={`mobile-menu-item ${currentPath === '/' ? 'active' : ''}`}>
            <i class="fas fa-home"></i>
            {t(translations, 'nav.home', 'Home')}
          </a>
          
          <div class="mobile-menu-section">
            <div class="mobile-menu-title">{t(translations, 'footer.game_categories', 'Game Categories')}</div>
            {Object.entries(pageStructure.categories).map(([path, info]) => (
              <a href={getLocalizedPath(path, currentLang)} class={`mobile-menu-item ${info.color} ${currentPath === path ? 'active' : ''}`}>
                <i class={info.icon}></i>
                {info.name}
              </a>
            ))}
          </div>
          
          <div class="mobile-menu-section">
            <div class="mobile-menu-title">{t(translations, 'nav.special', 'Special Pages')}</div>
            {Object.entries(pageStructure.special).map(([path, info]) => (
              <a href={getLocalizedPath(path, currentLang)} class={`mobile-menu-item ${info.color} ${currentPath === path ? 'active' : ''}`}>
                <i class={info.icon}></i>
                {info.name}
              </a>
            ))}
          </div>
          
          <div class="mobile-menu-section">
            <div class="mobile-menu-title">{t(translations, 'footer.support', 'Support')}</div>
            {Object.entries(pageStructure.support).map(([path, info]) => (
              <a href={getLocalizedPath(path, currentLang)} class={`mobile-menu-item ${info.color} ${currentPath === path ? 'active' : ''}`}>
                <i class={info.icon}></i>
                {info.name}
              </a>
            ))}
          </div>
          
          <!-- ç§»åŠ¨ç«¯è¯­è¨€åˆ‡æ¢ -->
          <div class="mobile-menu-section">
            <div class="mobile-menu-title">{t(translations, 'language.switch', 'Language')}</div>
            {languageSwitchLinks.map(link => (
              <a href={link.url} class={`mobile-menu-item language-item ${link.code === currentLang ? 'active' : ''}`} dir={link.dir}>
                <span class="language-flag">{link.flag}</span>
                <span class="language-name">{link.nativeName}</span>
                {link.code === currentLang && <i class="fas fa-check"></i>}
              </a>
            ))}
          </div>
        </div>
      </div>
    </header>
    
    <!-- ä¸»è¦å†…å®¹ -->
    <main id="main-content" class="flex-1">
      <slot />
    </main>
    
    <!-- é¡µè„š -->
    <footer class="footer">
      <div class="footer-container">
        <div class="footer-content">
          <!-- Logoå’Œæè¿° -->
          <div class="footer-section">
            <div class="footer-logo">
              <img src="/images/logo/edugamehq-footer.png" alt="EduGameHQ Logo" width="300" height="80" />
            </div>
            <p class="footer-description">
              {t(translations, 'footer.description', 'EduGameHQ is your go-to platform for educational games that make learning engaging and effective.')}
            </p>
          </div>

          <!-- æ¸¸æˆåˆ†ç±» -->
          <div class="footer-section">
            <h3 class="footer-title">{t(translations, 'footer.game_categories', 'Game Categories')}</h3>
            <ul class="footer-links">
              <li><a href={getLocalizedPath('/math-games', currentLang)}>{t(translations, 'categories.math-games', 'Math Games')}</a></li>
              <li><a href={getLocalizedPath('/science-games', currentLang)}>{t(translations, 'categories.science-games', 'Science Games')}</a></li>
              <li><a href={getLocalizedPath('/language-games', currentLang)}>{t(translations, 'categories.language-games', 'Language Games')}</a></li>
              <li><a href={getLocalizedPath('/puzzle-games', currentLang)}>{t(translations, 'categories.puzzle-games', 'Puzzle Games')}</a></li>
              <li><a href={getLocalizedPath('/sports-games', currentLang)}>{t(translations, 'categories.sports-games', 'Sports Games')}</a></li>
              <li><a href={getLocalizedPath('/art-games', currentLang)}>{t(translations, 'categories.art-games', 'Art & Creativity')}</a></li>
            </ul>
          </div>

          <!-- å¿«é€Ÿé“¾æ¥ -->
          <div class="footer-section">
            <h3 class="footer-title">{t(translations, 'footer.quick_links', 'Quick Links')}</h3>
            <ul class="footer-links">
              <li><a href={getLocalizedPath('/recently-played', currentLang)}>{t(translations, 'nav.recent', 'Recently Played')}</a></li>
              <li><a href={getLocalizedPath('/trending', currentLang)}>{t(translations, 'nav.trending', 'Trending Games')}</a></li>
              <li><a href={getLocalizedPath('/new-games', currentLang)}>{t(translations, 'nav.new', 'New Games')}</a></li>
            </ul>
          </div>

          <!-- æ”¯æŒ -->
          <div class="footer-section">
            <h3 class="footer-title">{t(translations, 'footer.support', 'Support')}</h3>
            <ul class="footer-links">
              <li><a href={getLocalizedPath('/help', currentLang)}>{t(translations, 'nav.help', 'Help Center')}</a></li>
              <li><a href={getLocalizedPath('/privacy-policy', currentLang)}>{t(translations, 'nav.privacy', 'Privacy Policy')}</a></li>
              <li><a href={getLocalizedPath('/terms-of-service', currentLang)}>{t(translations, 'nav.terms', 'Terms of Service')}</a></li>
              <li><a href={getLocalizedPath('/about', currentLang)}>{t(translations, 'nav.about', 'About Us')}</a></li>
            </ul>
          </div>
        </div>

        <!-- é¡µè„šåº•éƒ¨ -->
        <div class="footer-bottom">
          <div class="footer-bottom-content">
            <p class="footer-copyright">
              {t(translations, 'footer.copyright', 'Â© 2025 EduGameHQ. All rights reserved.')}
            </p>
            <p class="footer-tagline">
              {t(translations, 'footer.made_with_love', 'Made with â¤ï¸ for learners worldwide')}
            </p>
          </div>
        </div>
      </div>
    </footer>
  </div>

  <!-- å¯¼èˆªJavaScript -->
  <script is:inline>
    // å¤šè¯­è¨€æœç´¢åŠŸèƒ½
    function performSearch() {
      const searchBox = document.querySelector('.search-box');
      const query = searchBox.value.trim();
      if (query) {
        const currentLang = window.CURRENT_LANG || 'en';
        const searchPath = currentLang === 'en' ? '/search' : `/${currentLang}/search`;
        window.location.href = `${searchPath}?q=${encodeURIComponent(query)}`;
      }
    }

    // å›è½¦é”®æœç´¢
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ğŸ”§ åˆå§‹åŒ–å¯¼èˆªæ åŠŸèƒ½...');
      
      const searchBox = document.querySelector('.search-box');
      if (searchBox) {
        searchBox.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            performSearch();
          }
        });
      }

      // ä¸‹æ‹‰èœå•åŠŸèƒ½ - å¢å¼ºç‰ˆ
      function initializeDropdowns() {
        const dropdowns = document.querySelectorAll('.nav-dropdown');
        console.log(`ğŸ”½ æ‰¾åˆ° ${dropdowns.length} ä¸ªä¸‹æ‹‰èœå•`);
        
        // è¯¦ç»†æ£€æŸ¥æ¯ä¸ªä¸‹æ‹‰èœå•çš„HTMLç»“æ„
        dropdowns.forEach((dropdown, index) => {
          const trigger = dropdown.querySelector('.dropdown-trigger');
          const menu = dropdown.querySelector('.dropdown-menu');
          
          console.log(`ğŸ“‹ ä¸‹æ‹‰èœå• ${index + 1} è¯¦ç»†ä¿¡æ¯:`);
          console.log('- ä¸‹æ‹‰èœå•å®¹å™¨:', dropdown);
          console.log('- è§¦å‘æŒ‰é’®:', trigger);
          console.log('- ä¸‹æ‹‰èœå•:', menu);
          console.log('- è§¦å‘æŒ‰é’®ID:', trigger?.id || 'æ— ID');
          console.log('- ä¸‹æ‹‰èœå•ID:', menu?.id || 'æ— ID');
          console.log('- èœå•é¡¹æ•°é‡:', menu ? menu.querySelectorAll('.dropdown-item').length : 0);
          console.log('- å®Œæ•´HTMLç»“æ„:', dropdown.outerHTML.substring(0, 500) + '...');
          
          if (trigger && menu) {
            // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            trigger.removeEventListener('click', trigger._dropdownHandler);
            
            // åˆ›å»ºæ–°çš„äº‹ä»¶å¤„ç†å™¨
            trigger._dropdownHandler = function(e) {
              e.preventDefault();
              e.stopPropagation();
              
              console.log(`ğŸ–±ï¸ ç‚¹å‡»ä¸‹æ‹‰èœå•: ${trigger.id || 'æœªçŸ¥'}`);
              console.log(`ğŸ“‹ ç‚¹å‡»å‰çŠ¶æ€:`, {
                hasActiveClass: dropdown.classList.contains('active'),
                menuOpacity: getComputedStyle(menu).opacity,
                menuVisibility: getComputedStyle(menu).visibility,
                menuDisplay: getComputedStyle(menu).display,
                menuPointerEvents: getComputedStyle(menu).pointerEvents
              });
              
              // å…³é—­å…¶ä»–ä¸‹æ‹‰èœå•
              dropdowns.forEach(otherDropdown => {
                if (otherDropdown !== dropdown) {
                  otherDropdown.classList.remove('active');
                }
              });
              
              // åˆ‡æ¢å½“å‰ä¸‹æ‹‰èœå•
              const wasActive = dropdown.classList.contains('active');
              dropdown.classList.toggle('active');
              
              console.log(`ğŸ“Š ä¸‹æ‹‰èœå•çŠ¶æ€: ${wasActive ? 'å…³é—­' : 'æ‰“å¼€'}`);
              
              // æ£€æŸ¥åˆ‡æ¢åçš„çŠ¶æ€
              setTimeout(() => {
                console.log(`ğŸ” ç‚¹å‡»åçŠ¶æ€:`, {
                  hasActiveClass: dropdown.classList.contains('active'),
                  menuOpacity: getComputedStyle(menu).opacity,
                  menuVisibility: getComputedStyle(menu).visibility,
                  menuDisplay: getComputedStyle(menu).display,
                  menuPointerEvents: getComputedStyle(menu).pointerEvents,
                  menuZIndex: getComputedStyle(menu).zIndex
                });
              }, 100);
            };
            
            // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            trigger.addEventListener('click', trigger._dropdownHandler);
            console.log(`âœ… äº‹ä»¶ç›‘å¬å™¨å·²ç»‘å®šåˆ°: ${trigger.id || 'æœªçŸ¥ID'}`);
          } else {
            console.log(`âŒ ä¸‹æ‹‰èœå• ${index + 1} ç¼ºå°‘å¿…è¦å…ƒç´ :`, {
              hasTrigger: !!trigger,
              hasMenu: !!menu
            });
          }
        });
      }

      // åˆå§‹åŒ–ä¸‹æ‹‰èœå•
      initializeDropdowns();

      // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰èœå•
      document.addEventListener('click', function(e) {
        // æ£€æŸ¥ç‚¹å‡»çš„å…ƒç´ æ˜¯å¦åœ¨ä¸‹æ‹‰èœå•å†…
        const clickedDropdown = e.target.closest('.nav-dropdown');
        if (!clickedDropdown) {
          const dropdowns = document.querySelectorAll('.nav-dropdown');
          dropdowns.forEach(dropdown => {
            dropdown.classList.remove('active');
          });
        }
      });

      // ç§»åŠ¨ç«¯èœå•
      const mobileMenuBtn = document.getElementById('mobileMenuBtn');
      const mobileMenu = document.getElementById('mobileMenu');
      
      if (mobileMenuBtn && mobileMenu) {
        mobileMenuBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          mobileMenu.classList.toggle('active');
          mobileMenuBtn.classList.toggle('active');
          console.log('ğŸ“± ç§»åŠ¨ç«¯èœå•åˆ‡æ¢');
        });
      }

      // é”®ç›˜å¯¼èˆªæ”¯æŒ
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          // ESCé”®å…³é—­æ‰€æœ‰ä¸‹æ‹‰èœå•
          const dropdowns = document.querySelectorAll('.nav-dropdown');
          dropdowns.forEach(dropdown => {
            dropdown.classList.remove('active');
          });
          
          // å…³é—­ç§»åŠ¨ç«¯èœå•
          if (mobileMenu) {
            mobileMenu.classList.remove('active');
            mobileMenuBtn?.classList.remove('active');
          }
        }
      });

      console.log('âœ… å¯¼èˆªæ åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ');
    });

    // éšæœºæ¸¸æˆåŠŸèƒ½
    function playRandomGame() {
      const games = window.GAMES_DATA || [];
      if (games.length > 0) {
        const randomGame = games[Math.floor(Math.random() * games.length)];
        const currentLang = window.CURRENT_LANG || 'en';
        const gamePath = currentLang === 'en' ? `/games/${randomGame.slug}` : `/${currentLang}/games/${randomGame.slug}`;
        window.location.href = gamePath;
      }
    }
  </script>

  <!-- æ¸¸æˆç»Ÿè®¡å’Œæ”¶è—åŠŸèƒ½ -->
  <script src="/js/game-stats-manager.js" defer></script>
</body>
</html> 
