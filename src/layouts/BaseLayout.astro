---
import { generateStructuredData, getOGImageUrl } from '../data/seo-config';
import fs from 'fs';
import path from 'path';
// å¤šè¯­è¨€æ”¯æŒå¯¼å…¥
import { getLanguageFromPath, getTranslations, t, getLocalizedPath, isRTL, getLanguageInfo, getLanguageSwitchLinks, removeLanguagePrefix, type LanguageCode } from '../i18n/utils';
import { defaultLanguage, languages } from '../i18n/config';
// SEOå›½é™…åŒ–å·¥å…·å¯¼å…¥
import { getLocalizedSEO } from '../utils/seo-i18n';
// å¯¼å…¥æ ·å¼æ–‡ä»¶
import '../styles/language-switcher.css';
import '../styles/navbar.css';
import '../styles/footer.css';

// å¯¼å…¥å…¨æ–°çš„Logoç»„ä»¶
import Logo from '../components/ui/Logo.astro';

// è·å–æ‰€æœ‰è¯­è¨€çš„é¦–é¡µè·¯å¾„
const homePaths = Object.keys(languages).map(lang => getLocalizedPath('/', lang as LanguageCode));

export interface Props {
  title?: string;
  description?: string;
  bodyClass?: string;
  gameData?: any; // æ¸¸æˆé¡µé¢çš„æ¸¸æˆæ•°æ®
  lang?: LanguageCode; // å¯é€‰çš„è¯­è¨€å‚æ•°
}

const { title, description, bodyClass = "", gameData, lang } = Astro.props;

// è·å–å½“å‰é¡µé¢è·¯å¾„ï¼Œç”¨äºå¯¼èˆªé«˜äº®å’ŒSEOé…ç½®
const currentPath = Astro.url.pathname;

// è°ƒè¯•ä¿¡æ¯
console.log('ğŸ  é¦–é¡µè·¯å¾„åˆ—è¡¨:', homePaths);
console.log('ğŸŒ å½“å‰è·¯å¾„:', currentPath);

// å¤šè¯­è¨€é…ç½®
const currentLang = lang || getLanguageFromPath(currentPath);
const langInfo = getLanguageInfo(currentLang);
const translations = await getTranslations(currentLang);
const isRTLLang = isRTL(currentLang);

// è·å–è¯­è¨€åˆ‡æ¢é“¾æ¥ï¼ˆä½¿ç”¨æ¸…ç†åçš„è·¯å¾„ï¼‰
const cleanPath = removeLanguagePrefix(currentPath);
const languageSwitchLinks = getLanguageSwitchLinks(cleanPath);

// è·å–æœ¬åœ°åŒ–çš„SEOé…ç½®
const localizedSEO = await getLocalizedSEO(currentPath, currentLang);
const pageTitle = title || localizedSEO.title;


const pageDescription = description || localizedSEO.description;
const pageKeywords = localizedSEO.keywords;
const ogImageUrl = getOGImageUrl(currentPath);
const structuredData = generateStructuredData(currentPath, gameData);

// æ•™è‚²æœºæ„ç»“æ„åŒ–æ•°æ®
const educationalOrgData = {
  "@context": "https://schema.org",
  "@type": "EducationalOrganization",
  "name": "EduGameHQ",
  "alternateName": "Educational Games Headquarters",
  "description": "Free educational games platform for kids aged 6-18",
  "url": "https://www.edugamehq.com",
  "logo": "https://www.edugamehq.com/images/logo/edugamehq-logo.svg",
  "sameAs": [
    "https://twitter.com/EduGameHQ",
    "https://facebook.com/EduGameHQ",
    "https://youtube.com/EduGameHQ"
  ],
  "contactPoint": {
    "@type": "ContactPoint",
    "contactType": "customer support",
    "email": "support@edugamehq.com"
  },
  "educationalCredentialAwarded": "None",
  "hasOfferCatalog": {
    "@type": "OfferCatalog",
    "name": "Educational Games",
    "itemListElement": [
      {
        "@type": "OfferCategory",
        "name": "Math Games"
      },
      {
        "@type": "OfferCategory", 
        "name": "Science Games"
      },
      {
        "@type": "OfferCategory",
        "name": "Language Games"
      },
      {
        "@type": "OfferCategory",
        "name": "Coding Games"
      },
      {
        "@type": "OfferCategory",
        "name": "Puzzle Games"
      },
      {
        "@type": "OfferCategory",
        "name": "Sports Games"
      },
      {
        "@type": "OfferCategory",
        "name": "Art Games"
      }
    ]
  }
};

// æ„å»ºå®Œæ•´çš„é¡µé¢URL
const canonicalUrl = new URL(currentPath, Astro.site || 'https://www.edugamehq.com').toString();

// å®šä¹‰é¡µé¢åˆ†ç±»å’Œå±‚çº§ç»“æ„ - æ”¯æŒå¤šè¯­è¨€
// é¡µé¢ç»“æ„å®šä¹‰ - ä¸åŒ…å«ç¿»è¯‘ï¼Œç¿»è¯‘åœ¨æ¸²æŸ“æ—¶è¿›è¡Œ
const pageStructure = {
  categories: {
    '/math-games': { 
      translationKey: 'categories.math-games',
      fallback: 'Math Games',
      icon: 'fas fa-calculator', 
      color: 'math' 
    },
    '/science-games': { 
      translationKey: 'categories.science-games',
      fallback: 'Science Games',
      icon: 'fas fa-flask', 
      color: 'science' 
    },
    '/language-games': { 
      translationKey: 'categories.language-games',
      fallback: 'Language Games',
      icon: 'fas fa-book-open', 
      color: 'language' 
    },
    '/puzzle-games': { 
      translationKey: 'categories.puzzle-games',
      fallback: 'Puzzle Games',
      icon: 'fas fa-puzzle-piece', 
      color: 'puzzle' 
    },
    '/sports-games': { 
      translationKey: 'categories.sports-games',
      fallback: 'Sports Games',
      icon: 'fas fa-futbol', 
      color: 'sports' 
    },
    '/art-games': { 
      translationKey: 'categories.art-games',
      fallback: 'Art Games',
      icon: 'fas fa-palette', 
      color: 'art' 
    }
  },
  special: {
    '/trending': { 
      translationKey: 'nav.trending',
      fallback: 'Trending',
      icon: 'fas fa-fire', 
      color: 'trending' 
    },
    '/recently-played': { 
      translationKey: 'nav.recent',
      fallback: 'Recently Played',
      icon: 'fas fa-history', 
      color: 'recent' 
    },
    '/new-games': { 
      translationKey: 'nav.new',
      fallback: 'New Games',
      icon: 'fas fa-plus-circle', 
      color: 'new' 
    }
  },
  system: {
    '/favorites': { 
      translationKey: 'nav.favorites',
      fallback: 'Favorites',
      icon: 'fas fa-heart', 
      color: 'favorites' 
    },
    '/search': { 
      translationKey: 'nav.search',
      fallback: 'Search',
      icon: 'fas fa-search', 
      color: 'search' 
    }
  },
  support: {
    '/privacy-policy': { 
      translationKey: 'nav.privacy',
      fallback: 'Privacy Policy',
      icon: 'fas fa-shield-alt', 
      color: 'support' 
    },
    '/terms-of-service': { 
      translationKey: 'nav.terms',
      fallback: 'Terms of Service',
      icon: 'fas fa-file-contract', 
      color: 'support' 
    },
    '/help': { 
      translationKey: 'nav.help',
      fallback: 'Help & Support',
      icon: 'fas fa-life-ring', 
      color: 'support' 
    },
    '/about': { 
      translationKey: 'nav.about',
      fallback: 'About',
      icon: 'fas fa-info-circle', 
      color: 'support' 
    }
  }
};

// ç¡®å®šå½“å‰é¡µé¢ç±»å‹å’Œä¿¡æ¯
// ä¿®å¤ï¼šæ­£ç¡®åˆ¤æ–­æ‰€æœ‰è¯­è¨€çš„é¦–é¡µï¼ˆå¤„ç†å°¾éƒ¨æ–œæ é—®é¢˜ï¼‰
const normalizedCurrentPath = currentPath.endsWith('/') && currentPath.length > 1 ? currentPath.slice(0, -1) : currentPath;
const isHomePage = homePaths.includes(normalizedCurrentPath);

// è°ƒè¯•ä¿¡æ¯
console.log('ğŸ”§ æ ‡å‡†åŒ–è·¯å¾„:', normalizedCurrentPath);
console.log('âœ… æ˜¯å¦ä¸ºé¦–é¡µ:', isHomePage);

// ä¿®å¤è·¯å¾„åŒ¹é…é—®é¢˜ - ç¡®ä¿åœ¨æ„å»ºæ—¶ä¹Ÿèƒ½æ­£ç¡®åŒ¹é…
const normalizedPath = currentPath.endsWith('/') && currentPath.length > 1 ? currentPath.slice(0, -1) : currentPath;

// ğŸ”§ ä¿®å¤ï¼šå»é™¤è¯­è¨€å‰ç¼€åå†åŒ¹é…é¡µé¢ç»“æ„
const pathWithoutLang = removeLanguagePrefix(normalizedPath);
console.log('ğŸ” å»é™¤è¯­è¨€å‰ç¼€çš„è·¯å¾„:', pathWithoutLang);

const currentCategory = (pageStructure.categories as Record<string, any>)[pathWithoutLang];
const currentSpecialPage = (pageStructure.special as Record<string, any>)[pathWithoutLang];
const currentSystemPage = (pageStructure.system as Record<string, any>)[pathWithoutLang];
const currentSupportPage = (pageStructure.support as Record<string, any>)[pathWithoutLang];
const isGamePage = pathWithoutLang.startsWith('/games/');

// è¯»å–games.jsonæ•°æ®ç”¨äºå®¢æˆ·ç«¯
let gamesData = [];
try {
  const gamesDataPath = path.join(process.cwd(), 'src/data/games.json');
  const fileContent = fs.readFileSync(gamesDataPath, 'utf-8');
  gamesData = JSON.parse(fileContent);
} catch (error) {
  console.warn('Unable to read games data file:', error);
}

// æ„å»ºé¢åŒ…å±‘å¯¼èˆª - å¤šè¯­è¨€æ”¯æŒ
const breadcrumbs = [];
if (!isHomePage) {
  breadcrumbs.push({ 
    name: t(translations, 'nav.home', 'Home'), 
    url: getLocalizedPath('/', currentLang), 
    icon: 'fas fa-home' 
  });
  
  if (currentCategory) {
    // åˆ†ç±»é¡µé¢ï¼šç›´æ¥æ˜¾ç¤ºåˆ†ç±»åç§°ï¼Œä¸éœ€è¦ä¸­é—´çš„"åˆ†ç±»"ä¸‹æ‹‰
    breadcrumbs.push({ 
      name: t(translations, currentCategory.translationKey, currentCategory.fallback), 
      url: getLocalizedPath(pathWithoutLang, currentLang), 
      icon: currentCategory.icon,
      color: currentCategory.color,
      isCurrent: true 
    });
  } else if (currentSpecialPage) {
    // ç‰¹æ®Šé¡µé¢ï¼šç›´æ¥æ˜¾ç¤ºé¡µé¢åç§°ï¼Œä¸éœ€è¦ä¸­é—´çš„"åˆ†ç±»"ä¸‹æ‹‰
    breadcrumbs.push({ 
      name: t(translations, currentSpecialPage.translationKey, currentSpecialPage.fallback), 
      url: getLocalizedPath(pathWithoutLang, currentLang), 
      icon: currentSpecialPage.icon,
      color: currentSpecialPage.color,
      isCurrent: true 
    });
  } else if (currentSystemPage) {
    // ç³»ç»Ÿé¡µé¢é¢åŒ…å±‘ï¼ˆå¦‚æ”¶è—ã€æœç´¢ç­‰ï¼‰
    breadcrumbs.push({ 
      name: t(translations, currentSystemPage.translationKey, currentSystemPage.fallback), 
      url: getLocalizedPath(pathWithoutLang, currentLang), 
      icon: currentSystemPage.icon,
      color: currentSystemPage.color,
      isCurrent: true 
    });
  } else if (currentSupportPage) {
    // Supporté¡µé¢ï¼šç›´æ¥æ˜¾ç¤ºé¡µé¢åç§°ï¼Œä¸éœ€è¦ä¸­é—´çš„"Support"ä¸‹æ‹‰
    breadcrumbs.push({ 
      name: t(translations, currentSupportPage.translationKey, currentSupportPage.fallback), 
      url: getLocalizedPath(pathWithoutLang, currentLang), 
      icon: currentSupportPage.icon,
      color: currentSupportPage.color,
      isCurrent: true 
    });
  } else if (isGamePage) {
    // æ¸¸æˆé¡µé¢é¢åŒ…å±‘ - æ ¹æ®æ¸¸æˆæ‰€å±åˆ†ç±»æ¥ç¡®å®š
    breadcrumbs.push({ 
      name: t(translations, 'nav.categories', 'Categories'), 
      url: '#', 
      icon: 'fas fa-gamepad', 
      isDropdown: true 
    });
    
    // è·å–æ¸¸æˆæ•°æ®æ¥ç¡®å®šåˆ†ç±»
    let gameCategory = null;
    let gameTitle = 'Game';
    
    // å°è¯•ä»gameData propè·å–æ¸¸æˆä¿¡æ¯
    if (typeof gameData !== 'undefined' && gameData) {
      gameCategory = gameData.category;
      gameTitle = gameData.title || 'Game';
    } else {
      // ä»URLè·¯å¾„ä¸­æå–æ¸¸æˆslugï¼Œç„¶åæŸ¥æ‰¾å¯¹åº”çš„æ¸¸æˆæ•°æ®
      const gameSlug = currentPath.split('/').pop();
      if (gameSlug && gamesData.length > 0) {
        const game = gamesData.find((g: any) => g.slug === gameSlug);
        if (game) {
          gameCategory = game.category;
          gameTitle = game.title || 'Game';
        }
      }
    }
    
    // æ ¹æ®æ¸¸æˆåˆ†ç±»æ·»åŠ å¯¹åº”çš„åˆ†ç±»é¡µé¢é“¾æ¥
    if (gameCategory) {
      const categoryPath = `/${gameCategory}-games`;
      const categoryInfo = (pageStructure.categories as Record<string, any>)[categoryPath];
      
      if (categoryInfo) {
        breadcrumbs.push({ 
          name: categoryInfo.name, 
          url: getLocalizedPath(categoryPath, currentLang), 
          icon: categoryInfo.icon,
          color: categoryInfo.color
        });
      } else {
        // å¦‚æœæ‰¾ä¸åˆ°å¯¹åº”çš„åˆ†ç±»é¡µé¢ï¼Œä½¿ç”¨é€šç”¨åˆ†ç±»å
        const categoryName = gameCategory.charAt(0).toUpperCase() + gameCategory.slice(1) + ' Games';
        breadcrumbs.push({ 
          name: categoryName, 
          url: getLocalizedPath('/', currentLang), 
          icon: 'fas fa-gamepad',
          color: 'primary'
        });
      }
    } else {
      // å¦‚æœæ— æ³•ç¡®å®šåˆ†ç±»ï¼Œæ˜¾ç¤ºé€šç”¨æ¸¸æˆé“¾æ¥
      breadcrumbs.push({ 
        name: t(translations, 'game', 'Games'), 
        url: getLocalizedPath('/', currentLang), 
        icon: 'fas fa-gamepad' 
      });
    }
    
    // æ·»åŠ å½“å‰æ¸¸æˆåç§°ï¼ˆä¸é“¾æ¥ï¼‰- æ™ºèƒ½æˆªæ–­é•¿åç§°
    const truncatedTitle = gameTitle.length > 20 ? gameTitle.substring(0, 17) + '...' : gameTitle;
    breadcrumbs.push({ 
      name: truncatedTitle, 
      fullName: gameTitle, // ä¿å­˜å®Œæ•´åç§°ç”¨äºæ‚¬åœæ˜¾ç¤º
      url: '#', 
      icon: 'fas fa-gamepad',
      isCurrent: true,
      isLongTitle: gameTitle.length > 20 // æ ‡è®°æ˜¯å¦ä¸ºé•¿æ ‡é¢˜
    });
  }
}

// æ·»åŠ è¯¦ç»†çš„é¢åŒ…å±‘è°ƒè¯•ä¿¡æ¯
console.log('ğŸ é¢åŒ…å±‘è°ƒè¯•ä¿¡æ¯:');
console.log('- å½“å‰è·¯å¾„:', currentPath);
console.log('- å½“å‰è¯­è¨€:', currentLang);
console.log('- æ˜¯å¦é¦–é¡µ:', isHomePage);
console.log('- å½“å‰åˆ†ç±»:', currentCategory);
console.log('- é¢åŒ…å±‘æ•°ç»„é•¿åº¦:', breadcrumbs.length);
console.log('- é¢åŒ…å±‘å†…å®¹:', breadcrumbs);

// æ·»åŠ é¡µé¢ç»“æ„è°ƒè¯•ä¿¡æ¯
console.log('ğŸ“‹ é¡µé¢ç»“æ„è°ƒè¯•ä¿¡æ¯:');
console.log('- åˆ†ç±»æ•°é‡:', Object.keys(pageStructure.categories).length);
console.log('- åˆ†ç±»å†…å®¹:', pageStructure.categories);
console.log('- ç‰¹æ®Šé¡µé¢æ•°é‡:', Object.keys(pageStructure.special).length);
console.log('- ç‰¹æ®Šé¡µé¢å†…å®¹:', pageStructure.special);


---

<!DOCTYPE html>
<html lang={currentLang} dir={isRTLLang ? 'rtl' : 'ltr'}>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- é¡µé¢æ ‡é¢˜å’Œæè¿° -->
  <title>{pageTitle}</title>
  <meta name="description" content={pageDescription} />
  
  <!-- SEOå…³é”®è¯ -->
  <meta name="keywords" content={pageKeywords} />
  
  <!-- å…¶ä»–SEOå…ƒæ ‡ç­¾ -->
  <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
  <meta name="author" content="EduGameHQ">
  <meta name="language" content={langInfo.name}>
  <meta name="revisit-after" content="7 days">
  <meta name="distribution" content="global">
  <meta name="rating" content="general">
  
  <!-- åœ°ç†ä½ç½®æ ‡ç­¾ï¼ˆå…¨çƒæ•™è‚²å¹³å°ï¼‰-->
  <meta name="geo.region" content="US">
  <meta name="geo.placename" content="Global">
  <meta name="ICBM" content="39.7392, -104.9903">
  
  <!-- æ•™è‚²ç›¸å…³METAæ ‡ç­¾ -->
  <meta name="educational-level" content="K-12">
  <meta name="educational-audience" content="student">
  <meta name="educational-subject" content="mathematics,science,language arts,computer science,physical education,arts">
  
  <!-- Favicon - ä½¿ç”¨æ–°è®¾è®¡çš„LOGOï¼ˆæ·»åŠ ç‰ˆæœ¬å·å¼ºåˆ¶åˆ·æ–°ç¼“å­˜ï¼‰ -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg?v=3.0" />
  <link rel="icon" type="image/svg+xml" sizes="32x32" href="/favicon-32x32.svg?v=3.0" />
  <link rel="icon" type="image/svg+xml" sizes="16x16" href="/favicon-16x16.svg?v=3.0" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.svg?v=3.0" />
  <link rel="manifest" href="/site.webmanifest" />
  
  <!-- Canonical URL -->
  <link rel="canonical" href={canonicalUrl} />
  
  <!-- å¤šè¯­è¨€Alternate hreflangæ ‡ç­¾ -->
  {languageSwitchLinks.map(link => (
    <link rel="alternate" hreflang={link.code} href={new URL(link.url, Astro.site || 'https://www.edugamehq.com').toString()} />
  ))}
  <link rel="alternate" hreflang="x-default" href={new URL(getLocalizedPath(currentPath, defaultLanguage), Astro.site || 'https://www.edugamehq.com').toString()} />
  
  <!-- Fonts - ä¼˜åŒ–åŠ è½½ -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet" />
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" />
  
  <!-- Open Graph Meta Tags -->
  <meta property="og:title" content={pageTitle}>
  <meta property="og:description" content={pageDescription}>
  <meta property="og:type" content={isGamePage ? "game" : "website"}>
  <meta property="og:url" content={canonicalUrl}>
  <meta property="og:image" content={new URL(ogImageUrl, Astro.site || 'https://www.edugamehq.com').toString()}>
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:image:alt" content={pageTitle + ' - EduGameHQ Educational Games'}>
  <meta property="og:site_name" content="EduGameHQ">
  <meta property="og:locale" content={currentLang === 'en' ? 'en_US' : currentLang + '_' + currentLang.toUpperCase()}>
  
  <!-- Twitter Card Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@EduGameHQ">
  <meta name="twitter:creator" content="@EduGameHQ">
  <meta name="twitter:title" content={pageTitle}>
  <meta name="twitter:description" content={pageDescription}>
  <meta name="twitter:image" content={new URL(ogImageUrl, Astro.site || 'https://www.edugamehq.com').toString()}>
  <meta name="twitter:image:alt" content={pageTitle + ' - EduGameHQ Educational Games'}>
  
  <!-- Facebook Meta Tags -->
  <meta property="fb:app_id" content="your-facebook-app-id">
  
  <!-- Pinterest Meta Tags -->
  <meta name="pinterest-rich-pin" content="true">
  
  <!-- LinkedIn Meta Tags -->
  <meta property="linkedin:owner" content="EduGameHQ">
  
  <!-- Preload critical resources -->
  <link rel="preload" href="/images/logo/edugamehq-logo.svg" as="image" />
  <link rel="preload" href="/images/logo/edugamehq-icon.svg" as="image" />
  <!-- <link rel="preload" href={ogImageUrl} as="image"> -->
  
  <!-- DNS Prefetch for external resources -->
  <link rel="dns-prefetch" href="//fonts.googleapis.com" />
  <link rel="dns-prefetch" href="//fonts.gstatic.com" />
  <link rel="dns-prefetch" href="//cdnjs.cloudflare.com" />
  <link rel="dns-prefetch" href="//www.googletagmanager.com" />
  
  <!-- Structured Data (JSON-LD) -->
  {structuredData && (
    <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
  )}
  
  <!-- Additional structured data for educational content -->
  <script type="application/ld+json" set:html={JSON.stringify(educationalOrgData)} />
  
  <!-- Google Analytics 4 - æš‚æ—¶æ³¨é‡Šæ‰ç”¨äºè¯Šæ–­ -->
  <!-- <script async src="https://www.googletagmanager.com/gtag/js?id=G-RR1NHJ49F5" is:inline></script>
  <script is:inline>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-RR1NHJ49F5', {
      page_title: document.title,
      page_location: window.location.href,
      content_group1: 'Educational Games',
      custom_map: {
        'dimension1': 'page_category',
        'dimension2': 'user_type'
      }
    });
  </script> -->
  
  <!-- Google Search Console Verification -->
  <!-- è¯·å°†ä¸‹é¢çš„éªŒè¯ä»£ç æ›¿æ¢ä¸ºGoogle Search Consoleæä¾›çš„çœŸå®éªŒè¯ä»£ç  -->
  <meta name="google-site-verification" content="è¯·åœ¨æ­¤å¤„ç²˜è´´Google Search Consoleæä¾›çš„éªŒè¯ä»£ç ">
  
  <!-- Bing Webmaster Tools Verification -->
  <meta name="msvalidate.01" content="EB5E4EA52C1CCD23BB71B259934EAE24">
  
  <!-- Yandex Verification -->
  <meta name="yandex-verification" content="60fb28260cdeec35">
  
  <!-- Theme Color for mobile browsers -->
  <meta name="theme-color" content="#F59E0B">
  <meta name="msapplication-TileColor" content="#F59E0B">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json" />
  
  <!-- æ€§èƒ½ä¼˜åŒ– -->
  <link rel="dns-prefetch" href="//fonts.googleapis.com" />
  <link rel="dns-prefetch" href="//cdnjs.cloudflare.com" />
  <link rel="dns-prefetch" href="//www.googletagmanager.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  
  <!-- æ¸¸æˆç»Ÿè®¡ç®¡ç†å™¨ - å…¨å±€åŠ è½½ -->
  <script src="/js/game-stats-manager.js" defer is:inline></script>
  
  <!-- å…¨å±€gamesæ•°æ® - ä¾›å®¢æˆ·ç«¯JavaScriptä½¿ç”¨ -->
  <script define:vars={{ gamesData, currentLang, translations }} is:inline>
    // è®¾ç½®å…¨å±€æ¸¸æˆæ•°æ®å’Œå¤šè¯­è¨€æ•°æ®
    window.GAMES_DATA = gamesData || [];
    window.CURRENT_LANG = currentLang;
    window.TRANSLATIONS = translations;
    console.log('ğŸŒ GAMES_DATAå·²è®¾ç½®ï¼Œæ¸¸æˆæ•°é‡:', window.GAMES_DATA.length);
    console.log('ğŸŒ å½“å‰è¯­è¨€:', window.CURRENT_LANG);
    console.log('ğŸ“Š GAMES_DATAå†…å®¹æ ·ä¾‹:', window.GAMES_DATA.slice(0, 2));
  </script>
  
  
  <!-- RTLæ ·å¼æ”¯æŒ -->
  {isRTLLang && (
    <style>
      body { direction: rtl; }
      .search-container { order: -1; }
      .nav-actions { order: 1; }
      .breadcrumb-separator { transform: scaleX(-1); }
    </style>
  )}
  
</head>

<body class={`min-h-screen ${bodyClass} ${isRTLLang ? 'rtl' : 'ltr'}`}>
  

  
  <!-- Skip to main content for accessibility -->
  <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-gold-500 text-white px-4 py-2 rounded-lg z-50">
    {t(translations, 'common.skip_to_content', 'Skip to main content')}
  </a>
  
  <!-- é¡µé¢å†…å®¹ -->
  <div class="flex flex-col min-h-screen">
    <!-- å¯¼èˆªæ  -->
    <header class="navbar">
      <div class="nav-container">
        <!-- Logo -->
        <a href="/" class="nav-logo flex items-center gap-3">
          <Logo />
        </a>
        
        <!-- ä¸­é—´éƒ¨åˆ†å®¹å™¨ï¼šåŒ…å«é¢åŒ…å±‘å’Œæœç´¢æ¡† -->
        <div class="nav-center-group">
          <!-- æ™ºèƒ½é¢åŒ…å±‘å¯¼èˆª -->
          <nav class="nav-menu" aria-label="Main navigation">
            <div class="nav-breadcrumbs">
              <!-- Step 1: å§‹ç»ˆæ˜¾ç¤ºé¦–é¡µé“¾æ¥ -->
              <a href={getLocalizedPath('/', currentLang)} class={`nav-link ${isHomePage ? 'current' : ''}`} aria-current={isHomePage ? 'page' : 'false'}>
                <i class="fas fa-home"></i>
                {t(translations, 'nav.home', 'Home')}
              </a>

              <!-- Step 2: å§‹ç»ˆæ˜¾ç¤ºåˆ†ç±»ä¸‹æ‹‰èœå• -->
              <div class="nav-dropdown">
                <button class="nav-link dropdown-trigger" id="categoriesDropdown">
                  <i class="fas fa-gamepad"></i>
                  {t(translations, 'nav.categories', 'Categories')}
                  <i class="fas fa-chevron-down dropdown-arrow"></i>
                </button>
                <div class="dropdown-menu" id="categoriesMenu">
                  <!-- æ¸¸æˆåˆ†ç±» -->
                  {Object.entries(pageStructure.categories).map(([path, info]) => (
                    <a href={getLocalizedPath(path, currentLang)} class={`dropdown-item ${info.color}`}>
                      <i class={info.icon}></i>
                      {t(translations, info.translationKey, info.fallback)}
                    </a>
                  ))}
                  <!-- åˆ†éš”çº¿ -->
                  <hr class="dropdown-divider">
                  <!-- ç‰¹æ®Šé¡µé¢ -->
                  {Object.entries(pageStructure.special).map(([path, info]) => (
                    <a href={getLocalizedPath(path, currentLang)} class={`dropdown-item ${info.color}`}>
                      <i class={info.icon}></i>
                      {t(translations, info.translationKey, info.fallback)}
                    </a>
                  ))}
                </div>
              </div>

              <!-- Step 3: éé¦–é¡µæ—¶æ˜¾ç¤ºé¢åŒ…å±‘å¯¼èˆª -->
              {!isHomePage && breadcrumbs.slice(1).map((crumb) => (
                <div class="breadcrumb-item">
                  <i class="fas fa-chevron-right breadcrumb-separator"></i>
                  {crumb.isDropdown ? (
                    <div class="nav-dropdown">
                      <button class="nav-link dropdown-trigger" id={crumb.name === t(translations, 'footer.support', 'Support') ? 'supportDropdown' : 'defaultDropdown'}>
                        <i class={crumb.icon}></i>
                        {crumb.name}
                        <i class="fas fa-chevron-down dropdown-arrow"></i>
                      </button>
                      <div class="dropdown-menu" id={crumb.name === t(translations, 'footer.support', 'Support') ? 'supportMenu' : 'defaultMenu'}>
                        {crumb.name === t(translations, 'footer.support', 'Support') ? (
                          <>
                            {/* Supporté¡µé¢ */}
                            {Object.entries(pageStructure.support).map(([path, info]) => (
                              <a href={getLocalizedPath(path, currentLang)} class={`dropdown-item ${info.color} ${currentPath === path ? 'active' : ''}`}>
                                <i class={info.icon}></i>
                                {t(translations, info.translationKey, info.fallback)}
                              </a>
                            ))}
                          </>
                        ) : null}
                      </div>
                    </div>
                  ) : (
                    <a 
                      href={crumb.url} 
                      class={`nav-link ${crumb.isCurrent ? 'current' : ''} ${crumb.color || ''} ${crumb.isLongTitle ? 'long-title' : ''}`}
                      title={crumb.fullName || crumb.name}
                    >
                      <i class={crumb.icon}></i>
                      {crumb.name}
                    </a>
                  )}
                </div>
              ))}
            </div>
          </nav>
          
          <!-- æœç´¢åŒºåŸŸ -->
          <div class="search-container">
            <div class="search-wrapper">
              <i class="fas fa-search search-icon"></i>
              <input 
                type="text" 
                class="search-box" 
                placeholder={t(translations, 'search.placeholder', 'Search educational games...')}
                autocomplete="off"
              />
              <button type="button" class="search-button" onclick="performSearch()">
                <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        </div>
        
        <!-- å³ä¾§æŒ‰é’®ç»„ -->
        <div class="nav-actions">
          <!-- è¯­è¨€åˆ‡æ¢å™¨ -->
          <div class="nav-dropdown language-switcher">
            <button class="nav-btn language-btn dropdown-trigger" id="languageDropdown" title={t(translations, 'language.switch', 'Switch Language')}>
              <span class="language-flag">{langInfo.flag}</span>
              <span class="language-code">{currentLang.toUpperCase()}</span>
              <i class="fas fa-chevron-down dropdown-arrow"></i>
            </button>
            <div class="dropdown-menu language-menu" id="languageMenu">
              {languageSwitchLinks.map(link => (
                <a href={link.url} class={`dropdown-item language-item ${link.code === currentLang ? 'active' : ''}`} dir={link.dir}>
                  <span class="language-flag">{link.flag}</span>
                  <span class="language-name">{link.nativeName}</span>
                  {link.code === currentLang && <i class="fas fa-check"></i>}
                </a>
              ))}
            </div>
          </div>
          
          <a href={getLocalizedPath('/favorites', currentLang)} class={`nav-btn favorites-btn ${currentPath === '/favorites' ? 'current' : ''}`} title={t(translations, 'nav.favorites', 'Favorites')}>
            <i class="fas fa-heart"></i>
            <span class="nav-btn-text">{t(translations, 'nav.favorites', 'Favorites')}</span>
          </a>
          <button class="nav-btn random-btn" onclick="playRandomGame()" title={t(translations, 'game.random', 'Random Game')}>
            <i class="fas fa-dice"></i>
            <span class="nav-btn-text">{t(translations, 'game.random', 'Random')}</span>
          </button>
          
          <!-- ç§»åŠ¨ç«¯èœå•æŒ‰é’® -->
          <button class="mobile-menu-btn" id="mobileMenuBtn">
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
          </button>
        </div>
      </div>
      
      <!-- ç§»åŠ¨ç«¯èœå• -->
      <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-content">
          <a href={getLocalizedPath('/', currentLang)} class={`mobile-menu-item ${currentPath === '/' ? 'active' : ''}`}>
            <i class="fas fa-home"></i>
            {t(translations, 'nav.home', 'Home')}
          </a>
          
          <div class="mobile-menu-section">
            <div class="mobile-menu-title">{t(translations, 'footer.game_categories', 'Game Categories')}</div>
            {Object.entries(pageStructure.categories).map(([path, info]) => (
              <a href={getLocalizedPath(path, currentLang)} class={`mobile-menu-item ${info.color} ${currentPath === path ? 'active' : ''}`}>
                <i class={info.icon}></i>
                {t(translations, info.translationKey, info.fallback)}
              </a>
            ))}
          </div>
          
          <div class="mobile-menu-section">
            <div class="mobile-menu-title">{t(translations, 'nav.special', 'Special Pages')}</div>
            {Object.entries(pageStructure.special).map(([path, info]) => (
              <a href={getLocalizedPath(path, currentLang)} class={`mobile-menu-item ${info.color} ${currentPath === path ? 'active' : ''}`}>
                <i class={info.icon}></i>
                {t(translations, info.translationKey, info.fallback)}
              </a>
            ))}
          </div>
          
          <div class="mobile-menu-section">
            <div class="mobile-menu-title">{t(translations, 'footer.support', 'Support')}</div>
            {Object.entries(pageStructure.support).map(([path, info]) => (
              <a href={getLocalizedPath(path, currentLang)} class={`mobile-menu-item ${info.color} ${currentPath === path ? 'active' : ''}`}>
                <i class={info.icon}></i>
                {t(translations, info.translationKey, info.fallback)}
              </a>
            ))}
          </div>
          
          <!-- ç§»åŠ¨ç«¯è¯­è¨€åˆ‡æ¢ -->
          <div class="mobile-menu-section">
            <div class="mobile-menu-title">{t(translations, 'language.switch', 'Language')}</div>
            {languageSwitchLinks.map(link => (
              <a href={link.url} class={`mobile-menu-item language-item ${link.code === currentLang ? 'active' : ''}`} dir={link.dir}>
                <span class="language-flag">{link.flag}</span>
                <span class="language-name">{link.nativeName}</span>
                {link.code === currentLang && <i class="fas fa-check"></i>}
              </a>
            ))}
          </div>
        </div>
      </div>
    </header>
    
    <!-- ä¸»è¦å†…å®¹ -->
    <main id="main-content" class="flex-1">
      <slot />
    </main>
    
    <!-- é¡µè„š -->
    <footer class="footer">
      <div class="footer-container">
        <div class="footer-content">
          <!-- Logoå’Œæè¿° -->
          <div class="footer-section">
            <div class="footer-brand">
              <!-- Footer Logoå›¾æ ‡ - ä¸é¡¶éƒ¨å¯¼èˆªæ ä¿æŒä¸€è‡´ -->
              <div class="footer-logo-icon">
                <svg width="64" height="64" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                  <defs>
                    <linearGradient id="footer-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                      <stop offset="0%" style="stop-color:#FF6B35; stop-opacity:1" />
                      <stop offset="50%" style="stop-color:#F7931E; stop-opacity:1" />
                      <stop offset="100%" style="stop-color:#8B5CF6; stop-opacity:1" />
                    </linearGradient>
                    <linearGradient id="footer-book-gradient" x1="0%" y1="0%" x2="0%" y2="100%">
                      <stop offset="0%" style="stop-color:#60A5FA; stop-opacity:1" />
                      <stop offset="100%" style="stop-color:#3B82F6; stop-opacity:1" />
                    </linearGradient>
                    <filter id="footer-shadow">
                      <feDropShadow dx="0" dy="2" stdDeviation="2" flood-opacity="0.2"/>
                    </filter>
                  </defs>
                  
                  <!-- æ¸¸æˆæ‰‹æŸ„å¤–å½¢ -->
                  <g filter="url(#footer-shadow)">
                    <rect x="9" y="20" width="46" height="28" rx="14" ry="14" fill="url(#footer-gradient)"/>
                    <ellipse cx="14" cy="42" rx="9" ry="11" fill="url(#footer-gradient)"/>
                    <ellipse cx="50" cy="42" rx="9" ry="11" fill="url(#footer-gradient)"/>
                  </g>
                  
                  <!-- ä¸­å¿ƒï¼šæ‰“å¼€çš„ä¹¦æœ¬ -->
                  <g transform="translate(32, 34)">
                    <path d="M-9 -7 L-9 7 L-1 5 L-1 -9 Z" fill="white" opacity="0.95"/>
                    <path d="M1 -9 L1 5 L9 7 L9 -7 Z" fill="white" opacity="0.95"/>
                    <line x1="0" y1="-9" x2="0" y2="5" stroke="white" stroke-width="1.7" opacity="0.6"/>
                    
                    <!-- ä¹¦æœ¬è£…é¥°çº¿æ¡ -->
                    <line x1="-7" y1="-5" x2="-2" y2="-5" stroke="url(#footer-book-gradient)" stroke-width="1.2" opacity="0.8"/>
                    <line x1="-7" y1="-1" x2="-2" y2="-1" stroke="url(#footer-book-gradient)" stroke-width="1.2" opacity="0.8"/>
                    <line x1="2" y1="-5" x2="7" y2="-5" stroke="url(#footer-book-gradient)" stroke-width="1.2" opacity="0.8"/>
                    <line x1="2" y1="-1" x2="7" y2="-1" stroke="url(#footer-book-gradient)" stroke-width="1.2" opacity="0.8"/>
                  </g>
                  
                  <!-- æ¸¸æˆæŒ‰é’®å…ƒç´  -->
                  <g>
                    <!-- å·¦ä¾§æ–¹å‘é”® -->
                    <circle cx="18" cy="29" r="2.8" fill="white" opacity="0.9"/>
                    <circle cx="18" cy="39" r="2.8" fill="white" opacity="0.9"/>
                    <circle cx="14" cy="34" r="2.8" fill="white" opacity="0.9"/>
                    <circle cx="23" cy="34" r="2.8" fill="white" opacity="0.9"/>
                    
                    <!-- å³ä¾§åŠ¨ä½œæŒ‰é’® -->
                    <circle cx="46" cy="29" r="2.8" fill="white" opacity="0.9"/>
                    <circle cx="50" cy="34" r="2.8" fill="white" opacity="0.9"/>
                    <circle cx="46" cy="39" r="2.8" fill="white" opacity="0.9"/>
                    <circle cx="41" cy="34" r="2.8" fill="white" opacity="0.9"/>
                  </g>
                  
                  <!-- è£…é¥°æ˜Ÿæ˜Ÿ -->
                  <g opacity="0.8">
                    <path d="M7 11 L8 14 L11 14 L8.5 16 L9.5 19 L7 17 L4.5 19 L5.5 16 L3 14 L6 14 Z" fill="#FCD34D"/>
                    <path d="M57 11 L58 14 L61 14 L58.5 16 L59.5 19 L57 17 L54.5 19 L55.5 16 L53 14 L56 14 Z" fill="#FCD34D"/>
                  </g>
                </svg>
              </div>
              <!-- Footer Logoæ–‡å­— -->
              <div class="footer-logo-text">
                <span class="footer-edu">Edu</span><span class="footer-game">Game</span><span class="footer-hq">HQ</span>
              </div>
            </div>
            <p class="footer-description">
              {t(translations, 'footer.description', 'EduGameHQ is your go-to platform for educational games that make learning engaging and effective.')}
            </p>
          </div>

          <!-- æ¸¸æˆåˆ†ç±» -->
          <div class="footer-section">
            <h3 class="footer-title">{t(translations, 'footer.game_categories', 'Game Categories')}</h3>
            <ul class="footer-links">
              <li><a href={getLocalizedPath('/math-games', currentLang)}>{t(translations, 'categories.math-games', 'Math Games')}</a></li>
              <li><a href={getLocalizedPath('/science-games', currentLang)}>{t(translations, 'categories.science-games', 'Science Games')}</a></li>
              <li><a href={getLocalizedPath('/language-games', currentLang)}>{t(translations, 'categories.language-games', 'Language Games')}</a></li>
              <li><a href={getLocalizedPath('/puzzle-games', currentLang)}>{t(translations, 'categories.puzzle-games', 'Puzzle Games')}</a></li>
              <li><a href={getLocalizedPath('/sports-games', currentLang)}>{t(translations, 'categories.sports-games', 'Sports Games')}</a></li>
              <li><a href={getLocalizedPath('/art-games', currentLang)}>{t(translations, 'categories.art-games', 'Art & Creativity')}</a></li>
            </ul>
          </div>

          <!-- å¿«é€Ÿé“¾æ¥ -->
          <div class="footer-section">
            <h3 class="footer-title">{t(translations, 'footer.quick_links', 'Quick Links')}</h3>
            <ul class="footer-links">
              <li><a href={getLocalizedPath('/recently-played', currentLang)}>{t(translations, 'nav.recent', 'Recently Played')}</a></li>
              <li><a href={getLocalizedPath('/trending', currentLang)}>{t(translations, 'nav.trending', 'Trending Games')}</a></li>
              <li><a href={getLocalizedPath('/new-games', currentLang)}>{t(translations, 'nav.new', 'New Games')}</a></li>
            </ul>
          </div>

          <!-- æ”¯æŒ -->
          <div class="footer-section">
            <h3 class="footer-title">{t(translations, 'footer.support', 'Support')}</h3>
            <ul class="footer-links">
              <li><a href={getLocalizedPath('/help', currentLang)}>{t(translations, 'nav.help', 'Help Center')}</a></li>
              <li><a href={getLocalizedPath('/privacy-policy', currentLang)}>{t(translations, 'nav.privacy', 'Privacy Policy')}</a></li>
              <li><a href={getLocalizedPath('/terms-of-service', currentLang)}>{t(translations, 'nav.terms', 'Terms of Service')}</a></li>
              <li><a href={getLocalizedPath('/about', currentLang)}>{t(translations, 'nav.about', 'About Us')}</a></li>
            </ul>
          </div>
        </div>

        <!-- é¡µè„šåº•éƒ¨ -->
        <div class="footer-bottom">
          <div class="footer-bottom-content">
            <p class="footer-copyright">
              {t(translations, 'footer.copyright', 'Â© 2025 EduGameHQ. All rights reserved.')}
            </p>
            
            <!-- ç¤¾äº¤åˆ†äº«é“¾æ¥ç§»åŠ¨åˆ°è¿™é‡Œ -->
            <div class="footer-social-links">
              <a href="https://facebook.com/EduGameHQ" class="social-link facebook" target="_blank" rel="noopener noreferrer" aria-label={t(translations, 'footer.social.facebook', 'Facebook')}>
                <i class="fab fa-facebook-f"></i>
              </a>
              <a href="https://twitter.com/EduGameHQ" class="social-link twitter" target="_blank" rel="noopener noreferrer" aria-label={t(translations, 'footer.social.twitter', 'Twitter')}>
                <i class="fab fa-twitter"></i>
              </a>
              <a href="https://youtube.com/EduGameHQ" class="social-link youtube" target="_blank" rel="noopener noreferrer" aria-label={t(translations, 'footer.social.youtube', 'YouTube')}>
                <i class="fab fa-youtube"></i>
              </a>
              <a href="https://instagram.com/EduGameHQ" class="social-link instagram" target="_blank" rel="noopener noreferrer" aria-label={t(translations, 'footer.social.instagram', 'Instagram')}>
                <i class="fab fa-instagram"></i>
              </a>
            </div>

            <p class="footer-tagline">
              {t(translations, 'footer.made_with_love', 'Made with â¤ï¸ for learners worldwide')}
            </p>
          </div>
        </div>
      </div>
    </footer>
  </div>

  <!-- å¯¼èˆªJavaScript -->
  <script is:inline>
    // å¤šè¯­è¨€æœç´¢åŠŸèƒ½
    function performSearch() {
      const searchBox = document.querySelector('.search-box');
      const query = searchBox.value.trim();
      if (query) {
        const currentLang = window.CURRENT_LANG || 'en';
        const searchPath = currentLang === 'en' ? '/search' : `/${currentLang}/search`;
        window.location.href = `${searchPath}?q=${encodeURIComponent(query)}`;
      }
    }

    // å›è½¦é”®æœç´¢
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ğŸ”§ åˆå§‹åŒ–å¯¼èˆªæ åŠŸèƒ½...');
      
      const searchBox = document.querySelector('.search-box');
      if (searchBox) {
        searchBox.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            performSearch();
          }
        });
      }

      // ä¸‹æ‹‰èœå•åŠŸèƒ½ - å¢å¼ºç‰ˆ
      function initializeDropdowns() {
        const dropdowns = document.querySelectorAll('.nav-dropdown');
        console.log(`ğŸ”½ æ‰¾åˆ° ${dropdowns.length} ä¸ªä¸‹æ‹‰èœå•`);
        
        // è¯¦ç»†æ£€æŸ¥æ¯ä¸ªä¸‹æ‹‰èœå•çš„HTMLç»“æ„
        dropdowns.forEach((dropdown, index) => {
          const trigger = dropdown.querySelector('.dropdown-trigger');
          const menu = dropdown.querySelector('.dropdown-menu');
          
          console.log(`ğŸ“‹ ä¸‹æ‹‰èœå• ${index + 1} è¯¦ç»†ä¿¡æ¯:`);
          console.log('- ä¸‹æ‹‰èœå•å®¹å™¨:', dropdown);
          console.log('- è§¦å‘æŒ‰é’®:', trigger);
          console.log('- ä¸‹æ‹‰èœå•:', menu);
          console.log('- è§¦å‘æŒ‰é’®ID:', trigger?.id || 'æ— ID');
          console.log('- ä¸‹æ‹‰èœå•ID:', menu?.id || 'æ— ID');
          console.log('- èœå•é¡¹æ•°é‡:', menu ? menu.querySelectorAll('.dropdown-item').length : 0);
          console.log('- å®Œæ•´HTMLç»“æ„:', dropdown.outerHTML.substring(0, 500) + '...');
          
          if (trigger && menu) {
            // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            trigger.removeEventListener('click', trigger._dropdownHandler);
            
            // åˆ›å»ºæ–°çš„äº‹ä»¶å¤„ç†å™¨
            trigger._dropdownHandler = function(e) {
              e.preventDefault();
              e.stopPropagation();
              
              console.log(`ğŸ–±ï¸ ç‚¹å‡»ä¸‹æ‹‰èœå•: ${trigger.id || 'æœªçŸ¥'}`);
              console.log(`ğŸ“‹ ç‚¹å‡»å‰çŠ¶æ€:`, {
                hasActiveClass: dropdown.classList.contains('active'),
                menuOpacity: getComputedStyle(menu).opacity,
                menuVisibility: getComputedStyle(menu).visibility,
                menuDisplay: getComputedStyle(menu).display,
                menuPointerEvents: getComputedStyle(menu).pointerEvents
              });
              
              // å…³é—­å…¶ä»–ä¸‹æ‹‰èœå•
              dropdowns.forEach(otherDropdown => {
                if (otherDropdown !== dropdown) {
                  otherDropdown.classList.remove('active');
                }
              });
              
              // åˆ‡æ¢å½“å‰ä¸‹æ‹‰èœå•
              const wasActive = dropdown.classList.contains('active');
              dropdown.classList.toggle('active');
              
              console.log(`ğŸ“Š ä¸‹æ‹‰èœå•çŠ¶æ€: ${wasActive ? 'å…³é—­' : 'æ‰“å¼€'}`);
              
              // æ£€æŸ¥åˆ‡æ¢åçš„çŠ¶æ€
              setTimeout(() => {
                console.log(`ğŸ” ç‚¹å‡»åçŠ¶æ€:`, {
                  hasActiveClass: dropdown.classList.contains('active'),
                  menuOpacity: getComputedStyle(menu).opacity,
                  menuVisibility: getComputedStyle(menu).visibility,
                  menuDisplay: getComputedStyle(menu).display,
                  menuPointerEvents: getComputedStyle(menu).pointerEvents,
                  menuZIndex: getComputedStyle(menu).zIndex
                });
              }, 100);
            };
            
            // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            trigger.addEventListener('click', trigger._dropdownHandler);
            console.log(`âœ… äº‹ä»¶ç›‘å¬å™¨å·²ç»‘å®šåˆ°: ${trigger.id || 'æœªçŸ¥ID'}`);
          } else {
            console.log(`âŒ ä¸‹æ‹‰èœå• ${index + 1} ç¼ºå°‘å¿…è¦å…ƒç´ :`, {
              hasTrigger: !!trigger,
              hasMenu: !!menu
            });
          }
        });
      }

      // åˆå§‹åŒ–ä¸‹æ‹‰èœå•
      initializeDropdowns();

      // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰èœå•
      document.addEventListener('click', function(e) {
        // æ£€æŸ¥ç‚¹å‡»çš„å…ƒç´ æ˜¯å¦åœ¨ä¸‹æ‹‰èœå•å†…
        const clickedDropdown = e.target.closest('.nav-dropdown');
        if (!clickedDropdown) {
          const dropdowns = document.querySelectorAll('.nav-dropdown');
          dropdowns.forEach(dropdown => {
            dropdown.classList.remove('active');
          });
        }
      });

      // ç§»åŠ¨ç«¯èœå•
      const mobileMenuBtn = document.getElementById('mobileMenuBtn');
      const mobileMenu = document.getElementById('mobileMenu');
      
      if (mobileMenuBtn && mobileMenu) {
        mobileMenuBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          mobileMenu.classList.toggle('active');
          mobileMenuBtn.classList.toggle('active');
          console.log('ğŸ“± ç§»åŠ¨ç«¯èœå•åˆ‡æ¢');
        });
      }

      // é”®ç›˜å¯¼èˆªæ”¯æŒ
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          // ESCé”®å…³é—­æ‰€æœ‰ä¸‹æ‹‰èœå•
          const dropdowns = document.querySelectorAll('.nav-dropdown');
          dropdowns.forEach(dropdown => {
            dropdown.classList.remove('active');
          });
          
          // å…³é—­ç§»åŠ¨ç«¯èœå•
          if (mobileMenu) {
            mobileMenu.classList.remove('active');
            mobileMenuBtn?.classList.remove('active');
          }
        }
      });

      console.log('âœ… å¯¼èˆªæ åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ');
    });

    // éšæœºæ¸¸æˆåŠŸèƒ½
    function playRandomGame() {
      const games = window.GAMES_DATA || [];
      if (games.length > 0) {
        const randomGame = games[Math.floor(Math.random() * games.length)];
        const currentLang = window.CURRENT_LANG || 'en';
        // ä¿®å¤ï¼šæ‰€æœ‰è¯­è¨€éƒ½ä½¿ç”¨ç»Ÿä¸€çš„è·¯å¾„æ ¼å¼ /${language}/games/${slug}
        const gamePath = `/${currentLang}/games/${randomGame.slug}`;
        window.location.href = gamePath;
      }
    }
  </script>
  
</body>
</html>
