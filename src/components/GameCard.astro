---
// å¯¼å…¥ç±»å‹å®šä¹‰
import type { Game } from '../types/game';

// ç»„ä»¶å±æ€§æ¥å£
interface Props {
  game: Game;
  showTrending?: boolean;
  showFeatured?: boolean;
  showNew?: boolean;
  showUpdated?: boolean;
  showPopularity?: boolean;
  showFavorite?: boolean;
  showDeveloper?: boolean;
}

// è§£æ„å±æ€§å¹¶è®¾ç½®é»˜è®¤å€¼
const {
  game,
  showTrending = false,
  showFeatured = false,
  showNew = false,
  showUpdated = false,
  showPopularity = false,
  showFavorite = false,
  showDeveloper = false
} = Astro.props;

// ç¡®ä¿æ¸¸æˆå¯¹è±¡æœ‰æ•ˆ - ä¿®å¤ç±»å‹ä¸åŒ¹é…é—®é¢˜
const safeGame: Partial<Game> & Pick<Game, 'slug' | 'title' | 'description' | 'category' | 'categoryName' | 'iframeUrl' | 'difficulty' | 'ageRange' | 'minAge' | 'maxAge' | 'thumbnailUrl' | 'featured' | 'trending' | 'isNew' | 'tags' | 'developer' | 'source' | 'iframeCompatible' | 'verified'> = {
  slug: game.slug || '',
  title: game.title || 'Unknown Game',
  description: game.description || 'No description available',
  category: game.category || 'puzzle',
  categoryName: game.categoryName || 'Puzzle',
  iframeUrl: game.iframeUrl || '',
  difficulty: game.difficulty || 'Easy',
  ageRange: game.ageRange || '6-12',
  minAge: game.minAge || 6,
  maxAge: game.maxAge || 12,
  thumbnailUrl: game.thumbnailUrl || '/images/logo.svg',
  featured: game.featured || false,
  trending: game.trending || false,
  isNew: game.isNew || false,
  tags: game.tags || [],
  developer: game.developer || 'Unknown',
  source: game.source || 'External',
  iframeCompatible: game.iframeCompatible ?? true,
  verified: game.verified ?? true,
  ...game
};

// æ¸¸æˆURL
const gameUrl = `/games/${safeGame.slug}`;
---

<div class={`game-card ${safeGame.category}-theme animate-fadeInUp`} data-game-id={safeGame.slug}>
  <div class="game-image-container">
    <!-- ä¼˜åŒ–çš„å›¾ç‰‡æ‡’åŠ è½½ -->
    <div class="image-lazy-wrapper">
      <!-- æ¨¡ç³Šå ä½ç¬¦ -->
      <div class="image-placeholder">
        <div class="placeholder-shimmer"></div>
        <i class="fas fa-gamepad placeholder-icon"></i>
      </div>
      
      <!-- å®é™…å›¾ç‰‡ï¼ˆæ‡’åŠ è½½ï¼‰ -->
      <img 
        data-src={safeGame.thumbnailUrl}
        alt={safeGame.title}
        class="game-image lazy-image"
        onload="this.parentElement.classList.add('loaded')"
        onerror="this.dataset.src='/images/logo.svg'; this.src='/images/logo.svg'; this.parentElement.classList.add('loaded')"
      />
    </div>
    
    <!-- PlayæŒ‰é’®ç‹¬ç«‹å‡ºæ¥ -->
    <a href={gameUrl} class="play-button">
      <i class="fas fa-play"></i>
      <span>Play Now</span>
    </a>
    
    <!-- æ¸¸æˆå¾½ç« ç‹¬ç«‹å‡ºæ¥ -->
    <div class="game-badges">
      {(showTrending && safeGame.trending) && <span class="badge trending">HOT</span>}
      {(showFeatured && safeGame.featured) && <span class="badge featured">FEATURED</span>}
      {(showNew && safeGame.isNew) && <span class="badge new">NEW</span>}
      {showUpdated && <span class="badge updated">UPDATED</span>}
    </div>
    
    <!-- æ”¶è—æŒ‰é’®ç‹¬ç«‹å‡ºæ¥ï¼Œä¾èµ–å…¨å±€è„šæœ¬å¤„ç† -->
    {showFavorite && (
      <button class="favorite-heart-btn" data-game-slug={safeGame.slug} aria-label="Add to favorites">
        <i class="far fa-heart"></i>
      </button>
    )}
    
    <!-- å·¦ä¸Šè§’ï¼šæ¸¸æˆå†å²æ ‡ç­¾ - åŠ¨æ€æ˜¾ç¤º -->
    <div class="played-badge-container" data-game-slug={safeGame.slug}></div>
  </div>
  
  <div class="game-info">
    <h3 class="game-title">
      <a href={gameUrl}>{safeGame.title}</a>
    </h3>
    
    <p class="game-description">{safeGame.description}</p>
    
    <div class="game-tags">
      <span class={`category-tag ${safeGame.category}`}>{safeGame.categoryName}</span>
      {safeGame.featured && <span class="feature-tag featured">FEATURED</span>}
      {safeGame.trending && <span class="feature-tag hot">HOT</span>}
      {safeGame.isNew && <span class="feature-tag new">NEW</span>}
      <span class={`difficulty-tag ${safeGame.difficulty.toLowerCase()}`}>{safeGame.difficulty.toUpperCase()}</span>
    </div>
    
    <div class="game-stats">
      {showPopularity && (
        <div class="stat popularity-stat" data-game-slug={safeGame.slug}>
          <i class="fas fa-fire"></i>
          <span class="popularity-count">Loading...</span>
        </div>
      )}
      <div class="stat">
        <i class="fas fa-child"></i>
        <span>Ages {safeGame.ageRange}</span>
      </div>
      {showDeveloper && safeGame.developer && (
        <div class="stat">
          <i class="fas fa-user"></i>
          <span>{safeGame.developer}</span>
        </div>
      )}
    </div>
  </div>
</div>

<style>
  /* å¼•å…¥é€šç”¨æ¸¸æˆå¡ç‰‡æ ·å¼ */
  @import "/src/styles/game-card.css";

  /* ğŸš€ å›¾ç‰‡æ‡’åŠ è½½æ ·å¼ */
  .image-lazy-wrapper {
    position: relative;
    width: 100%;
    height: 100%;
    overflow: hidden;
    border-radius: 12px;
    background: #F8FAFC;
  }

  .image-placeholder {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #F1F5F9 0%, #E2E8F0 100%);
    z-index: 1;
    transition: opacity 0.3s ease;
  }

  .placeholder-shimmer {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(
      90deg,
      transparent 0%,
      rgba(255, 255, 255, 0.4) 50%,
      transparent 100%
    );
    animation: shimmer 1.5s infinite;
  }

  @keyframes shimmer {
    0% {
      transform: translateX(-100%);
    }
    100% {
      transform: translateX(100%);
    }
  }

  .placeholder-icon {
    font-size: 2rem;
    color: #CBD5E1;
    z-index: 2;
  }

  .lazy-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 2;
  }

  .image-lazy-wrapper.loaded .image-placeholder {
    opacity: 0;
    pointer-events: none;
  }

  .image-lazy-wrapper.loaded .lazy-image {
    opacity: 1;
  }

  /* äººæ°”å€¼ç­‰çº§æ ·å¼ */
  .popularity-count {
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .popularity-count.popularity-hot {
    color: #DC2626;
    text-shadow: 0 0 8px rgba(220, 38, 38, 0.3);
    animation: popularityPulse 2s infinite;
  }

  .popularity-count.popularity-high {
    color: #EA580C;
  }

  .popularity-count.popularity-medium {
    color: #CA8A04;
  }

  .popularity-count.popularity-low {
    color: #6B7280;
  }

  @keyframes popularityPulse {
    0%, 100% { 
      transform: scale(1); 
      opacity: 1; 
    }
    50% { 
      transform: scale(1.05); 
      opacity: 0.9; 
    }
  }
</style>

<script>
  // ğŸš€ å›¾ç‰‡æ‡’åŠ è½½å®ç°
  function initImageLazyLoading() {
    // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒ Intersection Observer
    if (!('IntersectionObserver' in window)) {
      // ä¸æ”¯æŒçš„è¯ï¼Œç›´æ¥åŠ è½½æ‰€æœ‰å›¾ç‰‡
      document.querySelectorAll('.lazy-image').forEach(img => {
        const dataSrc = img.getAttribute('data-src');
        if (dataSrc) {
          (img as HTMLImageElement).src = dataSrc;
        }
      });
      return;
    }

    // åˆ›å»º Intersection Observer
    const imageObserver = new IntersectionObserver((entries, observer) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const img = entry.target as HTMLImageElement;
          const dataSrc = img.getAttribute('data-src');
          
          if (dataSrc) {
            console.log('ğŸ–¼ï¸ å¼€å§‹åŠ è½½å›¾ç‰‡:', dataSrc);
            img.src = dataSrc;
            img.removeAttribute('data-src');
            observer.unobserve(img);
          }
        }
      });
    }, {
      // è®¾ç½®æ ¹è¾¹è·ï¼Œæå‰åŠ è½½å³å°†è¿›å…¥è§†å£çš„å›¾ç‰‡
      rootMargin: '50px 0px',
      threshold: 0.1
    });

    // è§‚å¯Ÿæ‰€æœ‰æ‡’åŠ è½½å›¾ç‰‡
    document.querySelectorAll('.lazy-image[data-src]').forEach(img => {
      imageObserver.observe(img);
    });

    console.log('ğŸ‘ï¸ å›¾ç‰‡æ‡’åŠ è½½è§‚å¯Ÿå™¨å·²åˆå§‹åŒ–');
  }

  // DOMåŠ è½½å®Œæˆååˆå§‹åŒ–
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initImageLazyLoading);
  } else {
    initImageLazyLoading();
  }

  // å¯¼å‡ºåˆ°å…¨å±€ï¼Œä¾›å…¶ä»–è„šæœ¬ä½¿ç”¨
  (window as any).initImageLazyLoading = initImageLazyLoading;
</script> 