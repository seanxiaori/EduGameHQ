---
// å¯¼å…¥ç±»å‹å®šä¹‰
import type { Game } from '../types/game';

// é€šç”¨æ¸¸æˆå¡ç‰‡ç»„ä»¶ - æ”¯æŒæ‰€æœ‰åŠ¨æ€æ•°æ®
export interface GameCardProps {
  game: {
    slug: string;
    title: string;
    description: string;
    thumbnailUrl: string;
    category: string;
    categoryName: string;
    difficulty: string;
    ageRange: string;
    minAge?: number;
    maxAge?: number;
    featured?: boolean;
    trending?: boolean;
    isNew?: boolean;
    playCount?: number;
    tags?: string[];
    developer?: string;
  };
  showPlayHistory?: boolean;
  showPopularity?: boolean;
  showDeveloper?: boolean;
}

// ç»„ä»¶å±æ€§æ¥å£
interface Props {
  game: Game;
  showTrending?: boolean;
  showFeatured?: boolean;
  showNew?: boolean;
  showUpdated?: boolean;
  showPlayHistory?: boolean;
  showPopularity?: boolean;
  showFavorite?: boolean;
  showDeveloper?: boolean;
  playCount?: number;
}

// è§£æ„å±æ€§å¹¶è®¾ç½®é»˜è®¤å€¼
const {
  game,
  showTrending = false,
  showFeatured = false,
  showNew = false,
  showUpdated = false,
  showPlayHistory = false,
  showPopularity = false,
  showFavorite = false,
  showDeveloper = false,
  playCount = 0
} = Astro.props;

// ç¡®ä¿æ¸¸æˆå¯¹è±¡æœ‰æ•ˆ
const safeGame: Game = {
  slug: '',
  title: 'Unknown Game',
  description: 'No description available',
  category: 'puzzle',
  categoryName: 'Puzzle',
  difficulty: 'Easy',
  ageRange: '6-12',
  thumbnailUrl: '/images/placeholder-game.jpg',
  gameUrl: '',
  featured: false,
  trending: false,
  isNew: false,
  tags: [],
  developer: 'Unknown',
  ...game
};

// æ ¼å¼åŒ–äººæ°”æ•°å­—
const formatPopularity = (num: number) => {
  if (!num || num === 0) return '0';
  if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
  if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
  return num.toString();
};

// æ¸¸æˆURL
const gameUrl = `/games/${safeGame.slug}`;
---

<!-- å¼•å…¥æ¸¸æˆç»Ÿè®¡ç®¡ç†å™¨ -->
<script src="/src/utils/game-stats-manager.js" is:inline></script>

<div class={`game-card ${safeGame.category}-theme animate-fadeInUp`} data-game-id={safeGame.slug}>
  <div class="game-image-container">
    <img 
      src={safeGame.thumbnailUrl} 
      alt={safeGame.title}
      class="game-image"
      loading="lazy"
      onerror="this.src='/images/logo.svg'"
    />
    
    <div class="game-overlay">
      <div class="game-badges">
        {(showTrending && safeGame.trending) && <span class="badge trending">HOT</span>}
        {(showFeatured && safeGame.featured) && <span class="badge featured">FEATURED</span>}
        {(showNew && safeGame.isNew) && <span class="badge new">NEW</span>}
        {showUpdated && <span class="badge updated">UPDATED</span>}
      </div>
      
      <a href={gameUrl} class="play-button">
        <i class="fas fa-play"></i>
        <span>Play Now</span>
      </a>
    </div>
    
    <!-- æ”¶è—æŒ‰é’®ç‹¬ç«‹å‡ºæ¥ï¼Œä¸å—è’™ç‰ˆå½±å“ -->
    {showFavorite && (
      <button class="favorite-heart-btn" data-game-slug={safeGame.slug} aria-label="Add to favorites">
        <i class="far fa-heart"></i>
      </button>
    )}
    
    <!-- å·¦ä¸Šè§’ï¼šæ¸¸æˆå†å²æ ‡ç­¾ - åŠ¨æ€æ˜¾ç¤º -->
    <div class="played-badge-container" data-game-slug={safeGame.slug}></div>
  </div>
  
  <div class="game-info">
    <h3 class="game-title">
      <a href={gameUrl}>{safeGame.title}</a>
    </h3>
    
    <p class="game-description">{safeGame.description}</p>
    
    <div class="game-tags">
      <span class={`category-tag ${safeGame.category}`}>{safeGame.categoryName}</span>
      {safeGame.featured && <span class="feature-tag featured">FEATURED</span>}
      {safeGame.trending && <span class="feature-tag hot">HOT</span>}
      {safeGame.isNew && <span class="feature-tag new">NEW</span>}
      <span class={`difficulty-tag ${safeGame.difficulty.toLowerCase()}`}>{safeGame.difficulty.toUpperCase()}</span>
    </div>
    
    <div class="game-stats">
      {showPopularity && (
        <div class="stat popularity-stat" data-game-slug={safeGame.slug}>
          <i class="fas fa-fire"></i>
          <span class="popularity-count">Loading...</span>
        </div>
      )}
      <div class="stat">
        <i class="fas fa-child"></i>
        <span>Ages {safeGame.ageRange}</span>
      </div>
      {showDeveloper && safeGame.developer && (
        <div class="stat">
          <i class="fas fa-user"></i>
          <span>{safeGame.developer}</span>
        </div>
      )}
    </div>
  </div>
</div>

<!-- ç®€åŒ–ç‰ˆæ”¶è—åŠŸèƒ½è°ƒè¯•è„šæœ¬ -->
<script define:vars={{ safeGame, showPlayHistory, showPopularity }}>
  // ç®€åŒ–ç‰ˆæ”¶è—ç®¡ç†å™¨ - ä¸“æ³¨è°ƒè¯•
  (function() {
    console.log('ğŸ”§ åˆå§‹åŒ–ç®€åŒ–ç‰ˆæ”¶è—ç®¡ç†å™¨...');
    
    const STORAGE_KEY = 'favoriteGames';
    
    // ç®€åŒ–çš„æ”¶è—ç®¡ç†ç±»
    class SimpleFavoriteManager {
      // æ£€æŸ¥æ˜¯å¦å·²æ”¶è—
      static isFavorited(gameSlug) {
        try {
          const favorites = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
          const result = favorites.includes(gameSlug);
          console.log(`ğŸ” æ£€æŸ¥æ”¶è—çŠ¶æ€ ${gameSlug}: ${result ? 'å·²æ”¶è—' : 'æœªæ”¶è—'}`);
          return result;
        } catch (error) {
          console.error('âŒ è¯»å–æ”¶è—çŠ¶æ€å¤±è´¥:', error);
          return false;
        }
      }
      
      // åˆ‡æ¢æ”¶è—çŠ¶æ€
      static toggleFavorite(gameSlug) {
        try {
          console.log(`ğŸ”„ å¼€å§‹åˆ‡æ¢æ”¶è—çŠ¶æ€: ${gameSlug}`);
          
          const favorites = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
          const currentlyFavorited = favorites.includes(gameSlug);
          
          console.log(`ğŸ“‹ å½“å‰æ”¶è—åˆ—è¡¨:`, favorites);
          console.log(`ğŸ“‹ å½“å‰çŠ¶æ€: ${currentlyFavorited ? 'å·²æ”¶è—' : 'æœªæ”¶è—'}`);
          
          let newFavorites;
          let newState;
          
          if (currentlyFavorited) {
            // ç§»é™¤æ”¶è—
            newFavorites = favorites.filter(id => id !== gameSlug);
            newState = false;
            console.log(`â– ç§»é™¤æ”¶è—: ${gameSlug}`);
          } else {
            // æ·»åŠ æ”¶è—
            newFavorites = [...favorites, gameSlug];
            newState = true;
            console.log(`â• æ·»åŠ æ”¶è—: ${gameSlug}`);
          }
          
          // ä¿å­˜åˆ°localStorage
          localStorage.setItem(STORAGE_KEY, JSON.stringify(newFavorites));
          console.log(`ğŸ’¾ ä¿å­˜æ–°çš„æ”¶è—åˆ—è¡¨:`, newFavorites);
          
          // ç«‹å³æ›´æ–°æ‰€æœ‰ç›¸å…³æŒ‰é’®
          this.updateAllButtonsForGame(gameSlug, newState);
          
          console.log(`âœ… æ”¶è—çŠ¶æ€æ›´æ–°å®Œæˆ ${gameSlug}: ${newState ? 'å·²æ”¶è—' : 'å·²å–æ¶ˆæ”¶è—'}`);
          
          // æ˜¾ç¤ºé€šçŸ¥
          this.showNotification(newState ? 'Added to favorites' : 'Removed from favorites', newState ? 'added' : 'removed');
          
        } catch (error) {
          console.error('âŒ æ”¶è—æ“ä½œå¤±è´¥:', error);
          this.showNotification('Something went wrong', 'error');
        }
      }
      
      // æ›´æ–°ç‰¹å®šæ¸¸æˆçš„æ‰€æœ‰æŒ‰é’®
      static updateAllButtonsForGame(gameSlug, isFavorited) {
        const gameCards = document.querySelectorAll(`[data-game-id="${gameSlug}"]`);
        console.log(`ğŸ”„ æ‰¾åˆ° ${gameCards.length} ä¸ª ${gameSlug} çš„æ¸¸æˆå¡ç‰‡`);
        
        gameCards.forEach((card, index) => {
          console.log(`ğŸ® å¤„ç†ç¬¬ ${index + 1} ä¸ªå¡ç‰‡`);
          const favoriteBtn = card.querySelector('.favorite-heart-btn');
          if (favoriteBtn) {
            console.log(`ğŸ’– æ‰¾åˆ°æ”¶è—æŒ‰é’®ï¼Œæ›´æ–°çŠ¶æ€: ${isFavorited ? 'å·²æ”¶è—' : 'æœªæ”¶è—'}`);
            this.updateButtonState(favoriteBtn, isFavorited);
          } else {
            console.log(`âš  æœªæ‰¾åˆ°æ”¶è—æŒ‰é’®`);
          }
        });
      }
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      static updateButtonState(button, isFavorited) {
        if (!button) {
          console.log(`âš  æŒ‰é’®ä¸å­˜åœ¨`);
          return;
        }
        
        console.log(`ğŸ¨ æ›´æ–°æŒ‰é’®æ ·å¼: ${isFavorited ? 'æ”¶è—çŠ¶æ€' : 'æœªæ”¶è—çŠ¶æ€'}`);
        
        const icon = button.querySelector('i');
        if (icon) {
          icon.className = isFavorited ? 'fas fa-heart' : 'far fa-heart';
          console.log(`ğŸ¯ å›¾æ ‡ç±»åæ›´æ–°ä¸º: ${icon.className}`);
        }
        
        // æ›´æ–°æ ·å¼
        if (isFavorited) {
          button.style.background = 'linear-gradient(135deg, #EC4899 0%, #DB2777 100%)';
          button.style.color = 'white';
          button.style.borderColor = 'rgba(236, 72, 153, 0.6)';
          button.style.boxShadow = '0 4px 15px rgba(236, 72, 153, 0.4)';
          button.classList.add('favorited');
        } else {
          button.style.background = 'rgba(0, 0, 0, 0.25)';
          button.style.color = '#FFFFFF';
          button.style.borderColor = 'rgba(255, 255, 255, 0.2)';
          button.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.2)';
          button.classList.remove('favorited');
        }
        
        // æ·»åŠ çŠ¶æ€åˆ‡æ¢åŠ¨ç”»
        button.style.transform = 'scale(1.1)';
        setTimeout(() => {
          button.style.transform = 'scale(1)';
        }, 150);
      }
      
      // æ˜¾ç¤ºé€šçŸ¥
      static showNotification(message, type) {
        console.log(`ğŸ“¢ æ˜¾ç¤ºé€šçŸ¥: ${message} (${type})`);
        
        const existingNotification = document.querySelector('.game-card-notification');
        if (existingNotification) {
          existingNotification.remove();
        }

        const notification = document.createElement('div');
        notification.className = `game-card-notification ${type}`;
        notification.style.cssText = `
          position: fixed !important;
          top: 2rem !important;
          right: 2rem !important;
          background: ${type === 'added' ? '#10B981' : type === 'removed' ? '#EF4444' : '#6B7280'} !important;
          color: white !important;
          padding: 0.75rem 1.25rem !important;
          border-radius: 8px !important;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
          z-index: 10000 !important;
          font-size: 0.875rem !important;
          font-weight: 600 !important;
          transform: translateX(100%) !important;
          opacity: 0 !important;
          transition: all 0.3s ease !important;
        `;
        
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.style.transform = 'translateX(0)';
          notification.style.opacity = '1';
        }, 10);
        
        setTimeout(() => {
          notification.style.transform = 'translateX(100%)';
          notification.style.opacity = '0';
          setTimeout(() => {
            if (document.body.contains(notification)) {
              document.body.removeChild(notification);
            }
          }, 300);
        }, 2000);
      }
    }
    
    // ç›´æ¥ç»‘å®šç‚¹å‡»äº‹ä»¶åˆ°æ‰€æœ‰æ”¶è—æŒ‰é’®
    function bindFavoriteButtons() {
      console.log('ğŸ”— å¼€å§‹ç»‘å®šæ”¶è—æŒ‰é’®äº‹ä»¶...');
      
      const favoriteButtons = document.querySelectorAll('.favorite-heart-btn');
      console.log(`ğŸ” æ‰¾åˆ° ${favoriteButtons.length} ä¸ªæ”¶è—æŒ‰é’®`);
      
      favoriteButtons.forEach((button, index) => {
        const gameSlug = button.getAttribute('data-game-slug');
        console.log(`ğŸ® ç¬¬ ${index + 1} ä¸ªæŒ‰é’®ï¼Œæ¸¸æˆ: ${gameSlug}`);
        
        if (!gameSlug) {
          console.error(`âŒ ç¬¬ ${index + 1} ä¸ªæŒ‰é’®ç¼ºå°‘ data-game-slug å±æ€§`);
          return;
        }
        
        // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        button.removeEventListener('click', button._favoriteClickHandler);
        
        // åˆ›å»ºæ–°çš„ç‚¹å‡»å¤„ç†å‡½æ•°
        button._favoriteClickHandler = function(e) {
          console.log(`ğŸ’– ç‚¹å‡»æ”¶è—æŒ‰é’®: ${gameSlug}`);
          e.preventDefault();
          e.stopPropagation();
          SimpleFavoriteManager.toggleFavorite(gameSlug);
        };
        
        // ç»‘å®šæ–°çš„äº‹ä»¶ç›‘å¬å™¨
        button.addEventListener('click', button._favoriteClickHandler);
        
        // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
        const isFavorited = SimpleFavoriteManager.isFavorited(gameSlug);
        SimpleFavoriteManager.updateButtonState(button, isFavorited);
        
        console.log(`âœ… ç¬¬ ${index + 1} ä¸ªæŒ‰é’®ç»‘å®šå®Œæˆ`);
      });
    }
    
    // åˆå§‹åŒ–å‡½æ•°
    function init() {
      console.log('ğŸš€ ç®€åŒ–ç‰ˆæ”¶è—ç®¡ç†å™¨åˆå§‹åŒ–å¼€å§‹...');
      
      // ç­‰å¾…DOMå®Œå…¨åŠ è½½
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          console.log('ğŸ“„ DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹ç»‘å®šæŒ‰é’®...');
          setTimeout(bindFavoriteButtons, 100);
        });
      } else {
        console.log('ğŸ“„ DOMå·²åŠ è½½ï¼Œç«‹å³ç»‘å®šæŒ‰é’®...');
        setTimeout(bindFavoriteButtons, 100);
      }
      
      console.log('âœ… ç®€åŒ–ç‰ˆæ”¶è—ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ');
    }
    
    // å¯åŠ¨åˆå§‹åŒ–
    init();
    
  })();
</script>

<style>
  /* å¼•å…¥é€šç”¨æ¸¸æˆå¡ç‰‡æ ·å¼ */
  @import "/src/styles/game-card.css";

  /* äººæ°”å€¼ç­‰çº§æ ·å¼ */
  .popularity-count {
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .popularity-count.popularity-hot {
    color: #DC2626;
    text-shadow: 0 0 8px rgba(220, 38, 38, 0.3);
    animation: popularityPulse 2s infinite;
  }

  .popularity-count.popularity-high {
    color: #EA580C;
  }

  .popularity-count.popularity-medium {
    color: #CA8A04;
  }

  .popularity-count.popularity-low {
    color: #6B7280;
  }

  @keyframes popularityPulse {
    0%, 100% { 
      transform: scale(1); 
      opacity: 1; 
    }
    50% { 
      transform: scale(1.05); 
      opacity: 0.9; 
    }
  }
</style> 