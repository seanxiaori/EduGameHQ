---
// 导入类型定义
import type { Game } from '../types/game';

// 通用游戏卡片组件 - 支持所有动态数据
export interface GameCardProps {
  game: {
    slug: string;
    title: string;
    description: string;
    thumbnailUrl: string;
    category: string;
    categoryName: string;
    difficulty: string;
    ageRange: string;
    minAge?: number;
    maxAge?: number;
    featured?: boolean;
    trending?: boolean;
    isNew?: boolean;
    playCount?: number;
    tags?: string[];
    developer?: string;
  };
  showPlayHistory?: boolean;
  showPopularity?: boolean;
  showDeveloper?: boolean;
}

// 组件属性接口
interface Props {
  game: Game;
  showTrending?: boolean;
  showFeatured?: boolean;
  showNew?: boolean;
  showUpdated?: boolean;
  showPlayHistory?: boolean;
  showPopularity?: boolean;
  showFavorite?: boolean;
  showDeveloper?: boolean;
  playCount?: number;
}

// 解构属性并设置默认值
const {
  game,
  showTrending = false,
  showFeatured = false,
  showNew = false,
  showUpdated = false,
  showPlayHistory = false,
  showPopularity = false,
  showFavorite = false,
  showDeveloper = false,
  playCount = 0
} = Astro.props;

// 确保游戏对象有效
const safeGame: Game = {
  slug: '',
  title: 'Unknown Game',
  description: 'No description available',
  category: 'puzzle',
  categoryName: 'Puzzle',
  difficulty: 'Easy',
  ageRange: '6-12',
  thumbnailUrl: '/images/placeholder-game.jpg',
  gameUrl: '',
  featured: false,
  trending: false,
  isNew: false,
  tags: [],
  developer: 'Unknown',
  ...game
};

// 格式化人气数字
const formatPopularity = (num: number) => {
  if (!num || num === 0) return '0';
  if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
  if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
  return num.toString();
};

// 游戏URL
const gameUrl = `/games/${safeGame.slug}`;
---

<!-- 引入游戏统计管理器 -->
<script src="/src/utils/game-stats-manager.js" is:inline></script>

<div class={`game-card ${safeGame.category}-theme animate-fadeInUp`} data-game-id={safeGame.slug}>
  <div class="game-image-container">
    <img 
      src={safeGame.thumbnailUrl} 
      alt={safeGame.title}
      class="game-image"
      loading="lazy"
      onerror="this.src='/images/logo.svg'"
    />
    
    <div class="game-overlay">
      <div class="game-badges">
        {(showTrending && safeGame.trending) && <span class="badge trending">HOT</span>}
        {(showFeatured && safeGame.featured) && <span class="badge featured">FEATURED</span>}
        {(showNew && safeGame.isNew) && <span class="badge new">NEW</span>}
        {showUpdated && <span class="badge updated">UPDATED</span>}
      </div>
      
      <a href={gameUrl} class="play-button">
        <i class="fas fa-play"></i>
        <span>Play Now</span>
      </a>
      
      {showFavorite && (
        <button class="favorite-heart-btn" data-game-slug={safeGame.slug} aria-label="Add to favorites">
          <i class="far fa-heart"></i>
        </button>
      )}
    </div>
    
    <!-- 左上角：游戏历史标签 - 动态显示 -->
    <div class="played-badge-container" data-game-slug={safeGame.slug}></div>
  </div>
  
  <div class="game-info">
    <h3 class="game-title">
      <a href={gameUrl}>{safeGame.title}</a>
    </h3>
    
    <p class="game-description">{safeGame.description}</p>
    
    <div class="game-tags">
      <span class={`category-tag ${safeGame.category}`}>{safeGame.categoryName}</span>
      {safeGame.featured && <span class="feature-tag featured">FEATURED</span>}
      {safeGame.trending && <span class="feature-tag hot">HOT</span>}
      {safeGame.isNew && <span class="feature-tag new">NEW</span>}
      <span class={`difficulty-tag ${safeGame.difficulty.toLowerCase()}`}>{safeGame.difficulty.toUpperCase()}</span>
    </div>
    
    <div class="game-stats">
      {showPopularity && (
        <div class="stat popularity-stat" data-game-slug={safeGame.slug}>
          <i class="fas fa-fire"></i>
          <span class="popularity-count">Loading...</span>
        </div>
      )}
      <div class="stat">
        <i class="fas fa-child"></i>
        <span>Ages {safeGame.ageRange}</span>
      </div>
      {showDeveloper && safeGame.developer && (
        <div class="stat">
          <i class="fas fa-user"></i>
          <span>{safeGame.developer}</span>
        </div>
      )}
    </div>
  </div>
</div>

<!-- 增强的游戏卡片管理器 - 修复收藏状态同步BUG -->
<script define:vars={{ safeGame, showPlayHistory, showPopularity }}>
  // 全局游戏卡片管理器 - 单例模式
  class GlobalGameCardManager {
    constructor() {
      if (window.globalGameCardManager) {
        return window.globalGameCardManager;
      }
      
      this.storageKey = 'favoriteGames';
      this.initialized = false;
      this.eventListeners = new Map(); // 追踪事件监听器
      window.globalGameCardManager = this;
      
      // 延迟初始化，确保DOM完全加载
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => this.init());
      } else {
        this.init();
      }
    }

    init() {
      if (this.initialized) return;
      
      console.log('🎮 初始化全局游戏卡片管理器...');
      
      // 立即初始化现有卡片
      this.initializeAllGameCards();
      
      // 设置DOM变化监听
      this.setupMutationObserver();
      
      // 设置localStorage变化监听
      this.setupStorageListener();
      
      // 设置全局事件监听
      this.setupGlobalEventListeners();
      
      this.initialized = true;
      console.log('✅ 全局游戏卡片管理器初始化完成');
    }

    setupMutationObserver() {
      // 监听DOM变化，自动初始化新添加的游戏卡片
      const observer = new MutationObserver((mutations) => {
        let hasNewCards = false;
        mutations.forEach(mutation => {
          mutation.addedNodes.forEach(node => {
            if (node.nodeType === Node.ELEMENT_NODE) {
              // 检查是否是游戏卡片或包含游戏卡片
              if (node.classList?.contains('game-card') || 
                  node.querySelector?.('.game-card')) {
                hasNewCards = true;
              }
            }
          });
        });
        
        if (hasNewCards) {
          console.log('🔄 检测到新的游戏卡片，重新初始化...');
          this.initializeAllGameCards();
        }
      });
      
      observer.observe(document.body, {
        childList: true,
        subtree: true
      });
    }

    setupStorageListener() {
      // 监听localStorage变化（跨标签页同步）
      window.addEventListener('storage', (e) => {
        if (e.key === this.storageKey) {
          console.log('📦 检测到收藏数据变化，同步所有按钮状态...');
          this.syncAllFavoriteButtons();
        }
      });
    }

    setupGlobalEventListeners() {
      // 监听统计数据更新
      window.addEventListener('gameStatsUpdated', (e) => {
        this.handleStatsUpdate(e.detail);
      });
      
      // 监听收藏变化事件
      window.addEventListener('favoritesChanged', (e) => {
        this.handleFavoritesChanged(e.detail);
      });
    }
    
    initializeAllGameCards() {
      // 获取所有游戏卡片（包括新添加的）
      const allGameCards = document.querySelectorAll('.game-card[data-game-id]');
      
      console.log(`🔍 找到 ${allGameCards.length} 个游戏卡片`);
      
      allGameCards.forEach(card => {
        const gameSlug = card.dataset.gameId;
        if (!gameSlug) return;

        // 初始化收藏按钮
        this.initializeFavoriteButton(card, gameSlug);
        
        // 更新动态数据显示
        this.updateDynamicData(card, gameSlug);
      });
    }

    initializeFavoriteButton(card, gameSlug) {
      const favoriteBtn = card.querySelector('.favorite-heart-btn');
      if (!favoriteBtn) return;

      // 清理旧的事件监听器
      this.cleanupEventListener(favoriteBtn, gameSlug);

      // 创建新的事件处理函数
      const clickHandler = (e) => {
        e.preventDefault();
        e.stopPropagation();
        console.log(`💖 点击收藏按钮: ${gameSlug}`);
        this.toggleFavorite(gameSlug);
      };

      // 绑定新的事件监听器
      favoriteBtn.addEventListener('click', clickHandler);
      
      // 记录事件监听器用于后续清理
      this.eventListeners.set(`${gameSlug}-favorite`, {
        element: favoriteBtn,
        handler: clickHandler,
        type: 'click'
      });

      // 立即设置正确的初始状态
      const isFavorited = this.isFavorited(gameSlug);
      this.updateFavoriteButtonState(favoriteBtn, isFavorited);
      
      console.log(`🎯 初始化收藏按钮 ${gameSlug}: ${isFavorited ? '已收藏' : '未收藏'}`);
    }

    cleanupEventListener(element, gameSlug) {
      const key = `${gameSlug}-favorite`;
      const listenerInfo = this.eventListeners.get(key);
      
      if (listenerInfo && listenerInfo.element === element) {
        element.removeEventListener(listenerInfo.type, listenerInfo.handler);
        this.eventListeners.delete(key);
      }
    }

    updateDynamicData(card, gameSlug) {
      // 更新人气值显示
      this.updatePopularityDisplay(card, gameSlug);
      
      // 更新游戏历史标签
      this.updatePlayHistoryBadge(card, gameSlug);
    }

    updatePopularityDisplay(card, gameSlug) {
      const popularityStat = card.querySelector('.popularity-stat');
      if (!popularityStat) return;

      const popularityCount = popularityStat.querySelector('.popularity-count');
      if (!popularityCount) return;

      let popularity;
      
      if (window.gameStatsManager) {
        popularity = window.gameStatsManager.getPopularity(gameSlug, safeGame);
      } else {
        // 使用备用计算方法
        popularity = this.calculateFallbackPopularity(gameSlug, safeGame);
      }

      popularityCount.textContent = this.formatPopularity(popularity) + ' popular';
      this.updatePopularityStyle(popularityCount, popularity);
    }

    updatePlayHistoryBadge(card, gameSlug) {
      if (!showPlayHistory) return;
      
      const badgeContainer = card.querySelector('.played-badge-container');
      if (!badgeContainer) return;

      if (window.gameStatsManager) {
        const historyLabel = window.gameStatsManager.getPlayHistoryLabel(gameSlug);
        if (historyLabel) {
          const badgeClass = this.getHistoryBadgeClass(historyLabel);
          badgeContainer.innerHTML = `<div class="played-badge ${badgeClass}">${historyLabel}</div>`;
        } else {
          badgeContainer.innerHTML = '';
        }
      }
    }

    // 检查是否已收藏
    isFavorited(gameSlug) {
      try {
        const favorites = JSON.parse(localStorage.getItem(this.storageKey) || '[]');
        const result = favorites.includes(gameSlug);
        console.log(`🔍 检查收藏状态 ${gameSlug}: ${result}`);
        return result;
      } catch (error) {
        console.error('❌ 读取收藏状态失败:', error);
        return false;
      }
    }

    // 切换收藏状态 - 修复版
    toggleFavorite(gameSlug) {
      try {
        const favorites = JSON.parse(localStorage.getItem(this.storageKey) || '[]');
        const currentlyFavorited = favorites.includes(gameSlug);
        
        console.log(`🔄 切换收藏状态 ${gameSlug}: ${currentlyFavorited ? '取消收藏' : '添加收藏'}`);
        
        let newFavorites;
        let newState;
        
        if (currentlyFavorited) {
          // 移除收藏
          newFavorites = favorites.filter(id => id !== gameSlug);
          newState = false;
          this.showNotification('Removed from favorites', 'removed');
        } else {
          // 添加收藏
          newFavorites = [...favorites, gameSlug];
          newState = true;
          this.showNotification('Added to favorites', 'added');
        }
        
        // 保存到localStorage
        localStorage.setItem(this.storageKey, JSON.stringify(newFavorites));
        
        // 立即更新所有相关按钮
        this.updateAllButtonsForGame(gameSlug, newState);
        
        // 触发全局事件
        window.dispatchEvent(new CustomEvent('favoritesChanged', {
          detail: { gameSlug, isFavorite: newState }
        }));
        
        console.log(`✅ 收藏状态更新成功 ${gameSlug}: ${newState}`);
        
      } catch (error) {
        console.error('❌ 收藏操作失败:', error);
        this.showNotification('Something went wrong', 'error');
      }
    }

    // 更新特定游戏的所有按钮
    updateAllButtonsForGame(gameSlug, isFavorited) {
      const gameCards = document.querySelectorAll(`[data-game-id="${gameSlug}"]`);
      console.log(`🔄 更新 ${gameCards.length} 个 ${gameSlug} 的收藏按钮状态: ${isFavorited}`);
      
      gameCards.forEach(card => {
        const favoriteBtn = card.querySelector('.favorite-heart-btn');
        if (favoriteBtn) {
          this.updateFavoriteButtonState(favoriteBtn, isFavorited);
        }
      });
    }

    // 同步所有收藏按钮状态
    syncAllFavoriteButtons() {
      const allGameCards = document.querySelectorAll('.game-card[data-game-id]');
      
      allGameCards.forEach(card => {
        const gameSlug = card.dataset.gameId;
        const favoriteBtn = card.querySelector('.favorite-heart-btn');
        
        if (gameSlug && favoriteBtn) {
          const isFavorited = this.isFavorited(gameSlug);
          this.updateFavoriteButtonState(favoriteBtn, isFavorited);
        }
      });
    }

    // 更新收藏按钮状态 - 增强版
    updateFavoriteButtonState(button, isFavorited) {
      if (!button) return;
      
      const icon = button.querySelector('i');
      if (icon) {
        icon.className = isFavorited ? 'fas fa-heart' : 'far fa-heart';
      }
      
      // 更新样式
      if (isFavorited) {
        button.style.background = 'linear-gradient(135deg, #EC4899 0%, #DB2777 100%)';
        button.style.color = 'white';
        button.style.borderColor = 'rgba(236, 72, 153, 0.6)';
        button.style.boxShadow = '0 4px 15px rgba(236, 72, 153, 0.4)';
        button.classList.add('favorited');
      } else {
        button.style.background = 'rgba(0, 0, 0, 0.25)';
        button.style.color = '#FFFFFF';
        button.style.borderColor = 'rgba(255, 255, 255, 0.2)';
        button.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.2)';
        button.classList.remove('favorited');
      }
      
      // 添加状态切换动画
      button.style.transform = 'scale(1.1)';
      setTimeout(() => {
        button.style.transform = 'scale(1)';
      }, 150);
    }

    // 工具方法
    calculateFallbackPopularity(gameSlug, gameInfo) {
      let basePopularity = 500;
      
      const categoryMultipliers = {
        'math': 1.8, 'science': 1.7, 'language': 1.6, 'puzzle': 1.4, 
        'art': 1.3, 'sports': 1.2, 'strategy': 1.5, 'adventure': 1.1, 'action': 1.0
      };
      
      basePopularity *= (categoryMultipliers[gameInfo.category] || 1.0);
      
      if (gameInfo.featured) basePopularity += 800;
      if (gameInfo.trending) basePopularity += 600;
      if (gameInfo.isNew) basePopularity += 400;
      
      // 基于gameSlug的一致性随机化
      let hash = 0;
      for (let i = 0; i < gameSlug.length; i++) {
        hash = ((hash << 5) - hash) + gameSlug.charCodeAt(i);
      }
      const randomVariation = (Math.abs(hash) % 400) - 200;
      basePopularity += randomVariation;
      
      return Math.max(Math.floor(basePopularity), 300);
    }

    updatePopularityStyle(element, popularity) {
      element.classList.remove('popularity-low', 'popularity-medium', 'popularity-high', 'popularity-hot');
      
      if (popularity >= 3000) {
        element.classList.add('popularity-hot');
      } else if (popularity >= 2000) {
        element.classList.add('popularity-high');
      } else if (popularity >= 1000) {
        element.classList.add('popularity-medium');
      } else {
        element.classList.add('popularity-low');
      }
    }

    getHistoryBadgeClass(label) {
      const classMap = {
        'Today': 'today',
        'Yesterday': 'yesterday',
        'A few days ago': 'few-days-ago',
        '2 weeks ago': 'weeks-ago',
        'A month ago': 'month-ago'
      };
      return classMap[label] || 'default';
    }

    formatPopularity(num) {
      if (!num || num === 0) return '0';
      if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
      if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
      return num.toString();
    }

    handleStatsUpdate(detail) {
      if (detail.gameSlug) {
        const cards = document.querySelectorAll(`[data-game-id="${detail.gameSlug}"]`);
        cards.forEach(card => {
          this.updateDynamicData(card, detail.gameSlug);
        });
      } else {
        this.initializeAllGameCards();
      }
    }

    handleFavoritesChanged(detail) {
      console.log('📢 收到收藏变化事件:', detail);
      // 这里可以添加额外的处理逻辑，比如更新其他UI元素
    }

    // 显示通知
    showNotification(message, type) {
      const existingNotification = document.querySelector('.game-card-notification');
      if (existingNotification) {
        existingNotification.remove();
      }

      const notification = document.createElement('div');
      notification.className = `game-card-notification ${type}`;
      notification.style.cssText = `
        position: fixed !important;
        top: 2rem !important;
        right: 2rem !important;
        background: ${type === 'added' ? '#10B981' : type === 'removed' ? '#EF4444' : '#6B7280'} !important;
        color: white !important;
        padding: 0.75rem 1.25rem !important;
        border-radius: 8px !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
        z-index: 10000 !important;
        font-size: 0.875rem !important;
        font-weight: 600 !important;
        transform: translateX(100%) !important;
        opacity: 0 !important;
        transition: all 0.3s ease !important;
      `;
      
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.transform = 'translateX(0)';
        notification.style.opacity = '1';
      }, 10);
      
      setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        notification.style.opacity = '0';
        setTimeout(() => {
          if (document.body.contains(notification)) {
            document.body.removeChild(notification);
          }
        }, 300);
      }, 2000);
    }
  }

  // 创建或获取全局管理器实例
  new GlobalGameCardManager();
</script>

<style>
  /* 引入通用游戏卡片样式 */
  @import "/src/styles/game-card.css";

  /* 人气值等级样式 */
  .popularity-count {
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .popularity-count.popularity-hot {
    color: #DC2626;
    text-shadow: 0 0 8px rgba(220, 38, 38, 0.3);
    animation: popularityPulse 2s infinite;
  }

  .popularity-count.popularity-high {
    color: #EA580C;
  }

  .popularity-count.popularity-medium {
    color: #CA8A04;
  }

  .popularity-count.popularity-low {
    color: #6B7280;
  }

  @keyframes popularityPulse {
    0%, 100% { 
      transform: scale(1); 
      opacity: 1; 
    }
    50% { 
      transform: scale(1.05); 
      opacity: 0.9; 
    }
  }
</style> 