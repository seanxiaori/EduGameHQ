name: ğŸ® è‡ªåŠ¨å‘ç°æ•™è‚²æ¸¸æˆ

# å®šæ—¶ä»»åŠ¡ï¼šæ¯å¤©UTC 2:00è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´10:00ï¼‰
# ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘
on:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©UTC 2:00
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

# è®¾ç½®æƒé™
permissions:
  contents: write
  pull-requests: write

jobs:
  discover-games:
    name: å‘ç°æ–°æ¸¸æˆ
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œä¾¿äºåˆ†æ
      
      # 2. è®¾ç½®Node.jsç¯å¢ƒ
      - name: ğŸ”§ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      # 3. å®‰è£…ä¾èµ–
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm ci
      
      # 4. è¿è¡Œæ™ºèƒ½çˆ¬è™«
      - name: ğŸ•·ï¸ è¿è¡Œæ™ºèƒ½çˆ¬è™«
        id: crawl
        run: |
          echo "ğŸš€ å¼€å§‹çˆ¬å–æ¸¸æˆæ•°æ®..."
          node scripts/intelligent-game-crawler.mjs
          
          # æ£€æŸ¥æ˜¯å¦å‘ç°äº†æ–°æ¸¸æˆ
          if [ -f "scripts/temp/new-games.json" ]; then
            echo "found_games=true" >> $GITHUB_OUTPUT
            GAME_COUNT=$(cat scripts/temp/new-games.json | grep -o '"slug"' | wc -l)
            echo "game_count=$GAME_COUNT" >> $GITHUB_OUTPUT
          else
            echo "found_games=false" >> $GITHUB_OUTPUT
            echo "game_count=0" >> $GITHUB_OUTPUT
          fi
      
      # 5. åˆ›å»ºåˆ†æ”¯å¹¶æäº¤æ›´æ”¹
      - name: ğŸ“ åˆ›å»ºåˆ†æ”¯å¹¶æäº¤
        if: steps.crawl.outputs.found_games == 'true'
        run: |
          # é…ç½®Git
          git config user.name "EduGameHQ Bot"
          git config user.email "bot@edugamehq.com"
          
          # åˆ›å»ºæ–°åˆ†æ”¯ï¼ˆä½¿ç”¨æ—¥æœŸå‘½åï¼‰
          BRANCH_NAME="auto-games-$(date +%Y%m%d-%H%M%S)"
          git checkout -b $BRANCH_NAME
          
          # æ·»åŠ æ›´æ”¹
          git add src/data/games.json
          
          # æäº¤
          GAME_COUNT="${{ steps.crawl.outputs.game_count }}"
          git commit -m "ğŸ® è‡ªåŠ¨å‘ç° $GAME_COUNT ä¸ªæ–°æ¸¸æˆ"
          
          # æ¨é€åˆ†æ”¯
          git push origin $BRANCH_NAME
          
          # ä¿å­˜åˆ†æ”¯åä¾›ä¸‹ä¸€æ­¥ä½¿ç”¨
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
      
      # 6. åˆ›å»ºPull Request
      - name: ğŸ”€ åˆ›å»º Pull Request
        if: steps.crawl.outputs.found_games == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ env.BRANCH_NAME }}
          title: "ğŸ® è‡ªåŠ¨å‘ç° ${{ steps.crawl.outputs.game_count }} ä¸ªæ–°æ•™è‚²æ¸¸æˆ"
          body-path: scripts/temp/pr-body.md
          labels: |
            auto-discovery
            games
            needs-review
          reviewers: ${{ github.repository_owner }}
      
      # 7. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      - name: ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        run: |
          if [ -d "scripts/temp" ]; then
            rm -rf scripts/temp
          fi
      
      # 8. è¾“å‡ºç»“æœ
      - name: âœ… è¾“å‡ºç»“æœ
        run: |
          if [ "${{ steps.crawl.outputs.found_games }}" == "true" ]; then
            echo "âœ… æˆåŠŸå‘ç° ${{ steps.crawl.outputs.game_count }} ä¸ªæ–°æ¸¸æˆï¼"
            echo "ğŸ“¬ å·²åˆ›å»ºPRç­‰å¾…å®¡æ ¸"
          else
            echo "â„¹ï¸ æœ¬æ¬¡æœªå‘ç°ç¬¦åˆæ¡ä»¶çš„æ–°æ¸¸æˆ"
          fi

