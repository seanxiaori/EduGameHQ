#!/usr/bin/env node

import fs from 'fs/promises';
import path from 'path';

console.log('ğŸš€ å¼€å§‹æœ¬åœ°éƒ¨ç½²å‡†å¤‡');

const sourceDir = './temp-games/ellie';
const outputDir = './github-games-repo';

console.log(`ğŸ“ æºè·¯å¾„: ${sourceDir}`);
console.log(`ğŸ“ è¾“å‡ºè·¯å¾„: ${outputDir}`);

try {
    // æ£€æŸ¥æºç›®å½•
    const items = await fs.readdir(sourceDir);
    console.log(`ğŸ“‹ å‘ç° ${items.length} ä¸ªé¡¹ç›®:`, items);
    
    // åˆ›å»ºè¾“å‡ºç›®å½•
    try {
        await fs.rm(outputDir, { recursive: true, force: true });
    } catch {}
    
    await fs.mkdir(outputDir, { recursive: true });
    await fs.mkdir(path.join(outputDir, 'games'), { recursive: true });
    
    console.log('âœ… ç›®å½•ç»“æ„åˆ›å»ºå®Œæˆ');
    
    // åˆ†ææ¸¸æˆ
    const games = [];
    for (const item of items) {
        const itemPath = path.join(sourceDir, item);
        const stat = await fs.stat(itemPath);
        
        if (stat.isDirectory() && !item.startsWith('.')) {
            const indexPath = path.join(itemPath, 'index.html');
            
            try {
                await fs.access(indexPath);
                games.push({
                    name: item,
                    path: itemPath
                });
                console.log(`  âœ… å‘ç°æ¸¸æˆ: ${item}`);
            } catch {
                console.log(`  âš ï¸  è·³è¿‡ ${item} (æ²¡æœ‰index.html)`);
            }
        }
    }
    
    console.log(`ğŸ® æ€»å…±å‘ç° ${games.length} ä¸ªæœ‰æ•ˆæ¸¸æˆ`);
    
    // å¤åˆ¶æ¸¸æˆæ–‡ä»¶
    for (const game of games) {
        const targetDir = path.join(outputDir, 'games', game.name);
        await copyDirectory(game.path, targetDir);
        console.log(`  âœ… å¤åˆ¶å®Œæˆ: ${game.name}`);
    }
    
    // ç”ŸæˆCNAMEæ–‡ä»¶
    await fs.writeFile(path.join(outputDir, 'CNAME'), 'games.edugamehq.com');
    
    // ç”Ÿæˆç®€å•çš„index.html
    const indexHtml = `<!DOCTYPE html>
<html>
<head>
    <title>EduGameHQ Games</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .game { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .game h3 { margin: 0 0 10px 0; }
        .play-btn { background: #007bff; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>ğŸ® EduGameHQ Games</h1>
    <p>Educational HTML5 Games Collection</p>
    
    ${games.map(game => `
    <div class="game">
        <h3>${game.name.replace(/-/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase())}</h3>
        <a href="./games/${game.name}/" class="play-btn">Play Now</a>
    </div>
    `).join('')}
    
    <footer style="margin-top: 40px; text-align: center; color: #666;">
        <p>Powered by <a href="https://edugamehq.com">EduGameHQ.com</a></p>
    </footer>
</body>
</html>`;
    
    await fs.writeFile(path.join(outputDir, 'index.html'), indexHtml);
    
    // ç”ŸæˆREADME
    const readme = `# EduGameHQ Games Repository

è¿™æ˜¯EduGameHQ.comçš„åŸåˆ›æ¸¸æˆæ‰˜ç®¡ä»“åº“ã€‚

## æ¸¸æˆåˆ—è¡¨

${games.map(game => `- ${game.name.replace(/-/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase())}`).join('\n')}

## éƒ¨ç½²è¯´æ˜

1. åœ¨GitHubåˆ›å»ºæ–°ä»“åº“ "EduGameHQ-Games"
2. å°†æ­¤ç›®å½•çš„æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ åˆ°ä»“åº“
3. åœ¨ä»“åº“è®¾ç½®ä¸­å¯ç”¨GitHub Pages
4. é…ç½®è‡ªå®šä¹‰åŸŸå games.edugamehq.com

---
Generated by EduGameHQ Games Deployer
`;
    
    await fs.writeFile(path.join(outputDir, 'README.md'), readme);
    
    console.log('âœ… æœ¬åœ°éƒ¨ç½²å‡†å¤‡å®Œæˆï¼');
    console.log(`ğŸ“ è¯·æŸ¥çœ‹: ${outputDir}`);
    console.log('');
    console.log('ğŸ”„ ä¸‹ä¸€æ­¥æ“ä½œ:');
    console.log('1. åœ¨GitHubåˆ›å»ºæ–°ä»“åº“ "EduGameHQ-Games"');
    console.log('2. å°†ç”Ÿæˆçš„æ–‡ä»¶ä¸Šä¼ åˆ°ä»“åº“');
    console.log('3. åœ¨ä»“åº“è®¾ç½®ä¸­å¯ç”¨GitHub Pages');
    console.log('4. é…ç½®è‡ªå®šä¹‰åŸŸå games.edugamehq.com');
    
} catch (error) {
    console.error('âŒ éƒ¨ç½²å¤±è´¥:', error.message);
}

// å¤åˆ¶ç›®å½•çš„è¾…åŠ©å‡½æ•°
async function copyDirectory(src, dest) {
    await fs.mkdir(dest, { recursive: true });
    const items = await fs.readdir(src);
    
    for (const item of items) {
        const srcPath = path.join(src, item);
        const destPath = path.join(dest, item);
        const stat = await fs.stat(srcPath);
        
        if (stat.isDirectory()) {
            await copyDirectory(srcPath, destPath);
        } else {
            await fs.copyFile(srcPath, destPath);
        }
    }
}